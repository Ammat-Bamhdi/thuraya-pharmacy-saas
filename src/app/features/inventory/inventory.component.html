
<div class="h-full flex flex-col animate-fade-in relative" (click)="closeActionMenu(); showBranchMenu.set(false)" role="main" aria-label="Inventory Management">
      
      <!-- Modern Header with Separated Context -->
      <header class="flex flex-col gap-6 mb-6 shrink-0">
        
        <!-- Top Row: Title & Context -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
           <div>
              <h1 class="text-2xl font-semibold tracking-tight text-slate-800">Inventory</h1>
              <p class="text-sm text-slate-500 mt-1">Product catalog & stock management</p>
           </div>

           <!-- High-Contrast Branch Switcher -->
           <div class="relative z-30" (click)="$event.stopPropagation()">
              <button 
                (click)="showBranchMenu.set(!showBranchMenu())"
                class="flex items-center gap-4 pl-2 pr-5 py-2 bg-slate-900 text-white rounded-full shadow-xl shadow-slate-900/20 hover:bg-slate-800 hover:scale-[1.02] transition-all group"
              >
                 <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-teal-400 border border-white/10">
                    <app-icon name="map-pin" [size]="18"></app-icon>
                 </div>
                 <div class="text-left">
                    <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider leading-none mb-1">Active Branch</div>
                    <div class="text-sm font-bold text-white leading-none tracking-wide">{{ getBranchName(selectedBranchId()) }}</div>
                 </div>
                 <div class="pl-2 border-l border-white/10 ml-1">
                    <app-icon name="chevron-down" [size]="16" class="text-slate-400 group-hover:text-white transition-colors" [class.rotate-180]="showBranchMenu()"></app-icon>
                 </div>
              </button>

              <!-- Dropdown Menu -->
              @if (showBranchMenu()) {
                 <div class="absolute top-full right-0 mt-3 w-80 bg-white rounded-2xl shadow-2xl border border-slate-100 overflow-hidden animate-fade-in origin-top-right ring-1 ring-black/5">
                    <div class="p-4 bg-slate-50/50 border-b border-slate-100 text-xs font-bold text-slate-500 uppercase tracking-wider flex justify-between items-center">
                       <span>Select Inventory Scope</span>
                       <span class="bg-teal-100 text-teal-700 px-2 py-0.5 rounded text-[10px]">Live</span>
                    </div>
                    <div class="max-h-72 overflow-y-auto p-2 space-y-1">
                       @for (b of store.branches(); track b.id) {
                          <button 
                             (click)="selectedBranchId.set(b.id); showBranchMenu.set(false)"
                             class="w-full flex items-center gap-4 p-3 rounded-xl transition-all text-left group border border-transparent"
                             [class.bg-teal-50]="selectedBranchId() === b.id"
                             [class.border-teal-100]="selectedBranchId() === b.id"
                             [class.hover:bg-slate-50]="selectedBranchId() !== b.id"
                          >
                             <div class="w-10 h-10 rounded-xl flex items-center justify-center shadow-sm border transition-all"
                                [class.bg-white]="selectedBranchId() === b.id" [class.text-teal-600]="selectedBranchId() === b.id" [class.border-teal-200]="selectedBranchId() === b.id"
                                [class.bg-slate-100]="selectedBranchId() !== b.id" [class.text-slate-400]="selectedBranchId() !== b.id" [class.border-slate-200]="selectedBranchId() !== b.id">
                                <span class="font-black text-sm tracking-tighter">{{ b.code.substring(0,2) }}</span>
                             </div>
                             <div class="flex-1">
                                <div class="text-sm font-bold" [class.text-teal-900]="selectedBranchId() === b.id" [class.text-slate-700]="selectedBranchId() !== b.id">{{ b.name }}</div>
                                <div class="text-[11px]" [class.text-teal-600]="selectedBranchId() === b.id" [class.text-slate-400]="selectedBranchId() !== b.id">{{ b.location }}</div>
                             </div>
                             @if (selectedBranchId() === b.id) {
                                <div class="w-2 h-2 rounded-full bg-teal-500 shadow-[0_0_8px_rgba(20,184,166,0.6)]"></div>
                             }
                          </button>
                       }
                    </div>
                    <div class="p-2 border-t border-slate-100 bg-slate-50/50">
                       <button (click)="store.setView('settings')" class="w-full py-2.5 text-xs font-bold text-slate-500 hover:text-slate-800 hover:bg-white rounded-xl border border-transparent hover:border-slate-200 transition-all flex items-center justify-center gap-2">
                          <app-icon name="settings" [size]="14"></app-icon> Manage Network
                       </button>
                    </div>
                 </div>
              }
           </div>
        </div>
      </header>

      <!-- Empty State for First Time Users -->
      @if (store.branches().length === 0) {
        <div class="glass-panel rounded-xl flex-1 flex items-center justify-center p-12" aria-label="No branches configured">
          <div class="text-center max-w-md">
            <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-amber-50 flex items-center justify-center">
              <app-icon name="map-pin" [size]="40" class="text-amber-500"></app-icon>
            </div>
            <h2 class="text-xl font-semibold text-slate-800 mb-2">No Branches Configured</h2>
            <p class="text-slate-500 mb-6 leading-relaxed">
              Create your first branch during onboarding to start managing inventory.
            </p>
            <button 
              (click)="store.setView('settings')"
              class="inline-flex items-center gap-2 px-6 py-3 bg-teal-600 text-white rounded-xl font-medium hover:bg-teal-700 transition-colors shadow-lg shadow-teal-500/20 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2"
            >
              <app-icon name="settings" [size]="18"></app-icon>
              Go to Settings
            </button>
          </div>
        </div>
      } @else if (store.products().length === 0 && store.suppliers().length === 0) {
        <!-- Empty State - No Products and No Suppliers -->
        <div class="glass-panel rounded-xl flex-1 flex items-center justify-center p-12" aria-label="Get started with inventory">
          <div class="text-center max-w-lg">
            <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-teal-400 to-teal-600 flex items-center justify-center shadow-xl shadow-teal-500/20">
              <app-icon name="package" [size]="40" class="text-white"></app-icon>
            </div>
            <h2 class="text-2xl font-semibold text-slate-800 mb-2">Start Building Your Inventory</h2>
            <p class="text-slate-500 mb-8 leading-relaxed">
              Before adding products, set up your suppliers. This helps track where your inventory comes from and streamlines purchase orders.
            </p>
            
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
              <button 
                (click)="store.setView('procurement-suppliers')"
                class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-teal-600 text-white rounded-xl font-medium hover:bg-teal-700 transition-colors shadow-lg shadow-teal-500/20 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2"
              >
                <app-icon name="truck" [size]="18"></app-icon>
                Add Suppliers First
              </button>
              <button 
                (click)="openAddModal()"
                class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-white text-slate-700 border border-slate-200 rounded-xl font-medium hover:bg-slate-50 transition-colors focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-offset-2"
              >
                <app-icon name="plus" [size]="18"></app-icon>
                Add Product Manually
              </button>
            </div>
            
            <!-- Quick Tip -->
            <div class="mt-8 p-4 bg-blue-50 rounded-xl border border-blue-100 text-left">
              <div class="flex items-start gap-3">
                <div class="w-8 h-8 rounded-lg bg-blue-100 flex items-center justify-center shrink-0">
                  <app-icon name="info" [size]="16" class="text-blue-600"></app-icon>
                </div>
                <div>
                  <h4 class="text-sm font-semibold text-blue-800">Pro Tip</h4>
                  <p class="text-sm text-blue-600 mt-1">
                    Adding suppliers first enables smart inventory ingestion from purchase orders, automatically tracking costs and batch numbers.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      } @else if (store.products().length === 0) {
        <!-- Empty State - Has Suppliers but No Products -->
        <div class="glass-panel rounded-xl flex-1 flex items-center justify-center p-12" aria-label="Add your first product">
          <div class="text-center max-w-md">
            <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-slate-100 flex items-center justify-center">
              <app-icon name="package" [size]="40" class="text-slate-400"></app-icon>
            </div>
            <h2 class="text-xl font-semibold text-slate-800 mb-2">No Products Yet</h2>
            <p class="text-slate-500 mb-6 leading-relaxed">
              Add your first product to start managing your pharmacy inventory. You can import from purchase orders or add manually.
            </p>
            <button 
              (click)="openAddModal()"
              class="inline-flex items-center gap-2 px-6 py-3 bg-teal-600 text-white rounded-xl font-medium hover:bg-teal-700 transition-colors shadow-lg shadow-teal-500/20 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2"
            >
              <app-icon name="plus" [size]="18"></app-icon>
              Add First Product
            </button>
          </div>
        </div>
      } @else {
      <div class="glass-panel rounded-xl flex flex-col flex-1 overflow-hidden animate-fade-in">
        <!-- Advanced Toolbar (Main List) -->
        <div class="p-4 border-b border-slate-100 flex flex-col xl:flex-row xl:items-center justify-between gap-4 bg-white/50">
          <!-- Filters -->
          <div class="flex flex-wrap items-center gap-3 w-full xl:w-auto">
             <!-- Search -->
             <div class="relative group w-full sm:w-64 transition-all duration-300 focus-within:w-72">
                <app-icon name="search" [size]="16" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-teal-500 transition-colors pointer-events-none"></app-icon>
                <input 
                  type="text" 
                  [(ngModel)]="searchQuery" 
                  placeholder="Search Name or SKU..." 
                  class="glass-input w-full pl-10 pr-9 py-2 rounded-lg text-xs bg-white transition-all"
                >
                @if (searchQuery()) {
                  <button (click)="searchQuery.set('')" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors p-1 rounded-full hover:bg-slate-100">
                    <app-icon name="x" [size]="12"></app-icon>
                  </button>
                }
             </div>

             <!-- Category Filter -->
             <div class="relative">
               <select [(ngModel)]="categoryFilter" class="glass-input pl-3 pr-8 py-2 rounded-lg text-xs bg-white appearance-none cursor-pointer hover:bg-slate-50 transition-colors min-w-[140px]">
                 <option value="All">All Categories</option>
                 <option value="Analgesic">Analgesic</option>
                 <option value="Antibiotic">Antibiotic</option>
                 <option value="Antihistamine">Antihistamine</option>
                 <option value="Cardiovascular">Cardiovascular</option>
                 <option value="Diabetes">Diabetes</option>
                 <option value="Supplement">Supplement</option>
                 <option value="General">General</option>
               </select>
               <app-icon name="chevron-down" [size]="12" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></app-icon>
             </div>

             <!-- Stock Filter -->
             <div class="relative">
               <select [(ngModel)]="stockFilter" class="glass-input pl-3 pr-8 py-2 rounded-lg text-xs bg-white appearance-none cursor-pointer hover:bg-slate-50 transition-colors min-w-[140px]">
                 <option value="All">All Stock Levels</option>
                 <option value="In Stock">In Stock</option>
                 <option value="Low Stock">Low Stock</option>
                 <option value="Out of Stock">Out of Stock</option>
               </select>
               <app-icon name="chevron-down" [size]="12" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></app-icon>
             </div>
          </div>

          <!-- Actions -->
          <div class="flex items-center gap-3">
             <!-- View Toggle -->
             <div class="bg-white border border-slate-200 p-1 rounded-lg flex items-center shadow-sm">
                <button 
                  (click)="activeView.set('list')" 
                  class="p-1.5 rounded-md transition-all duration-200 focus:outline-none flex items-center justify-center w-7 h-7"
                  [class]="activeView() === 'list' ? 'bg-slate-100 text-teal-600' : 'text-slate-400 hover:text-slate-600'"
                  title="List View"
                >
                  <app-icon name="layout-grid" [size]="14" class="rotate-90"></app-icon>
                </button>
                <button 
                  (click)="activeView.set('grid')" 
                  class="p-1.5 rounded-md transition-all duration-200 focus:outline-none flex items-center justify-center w-7 h-7"
                  [class]="activeView() === 'grid' ? 'bg-slate-100 text-teal-600' : 'text-slate-400 hover:text-slate-600'"
                  title="Grid View"
                >
                  <app-icon name="layout-grid" [size]="14"></app-icon>
                </button>
             </div>

             <button (click)="exportToPrint()" class="px-3 py-2 bg-white border border-slate-200 text-slate-600 rounded-lg text-xs hover:bg-slate-50 flex items-center gap-2 transition-all shadow-sm">
                <app-icon name="printer" [size]="14"></app-icon> Print
             </button>

             <button (click)="openAddModal()" class="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white shadow-lg shadow-slate-800/20 rounded-lg text-xs transition-all flex items-center gap-2 font-medium">
                <app-icon name="plus" [size]="14"></app-icon> Add Product
             </button>
          </div>
        </div>

        <!-- Content Area -->
        <div class="flex-1 overflow-auto bg-slate-50/30">
          
          <!-- LIST VIEW -->
          @if (activeView() === 'list') {
            <table class="w-full text-left border-collapse">
              <thead class="sticky top-0 bg-white/95 backdrop-blur z-10 text-xs uppercase text-slate-400 font-medium shadow-sm">
                <tr>
                  @for (col of visibleColumns(); track col.key) {
                    <th (click)="sort(col.key)" class="p-3 font-medium border-b border-slate-100 cursor-pointer hover:bg-slate-50 transition-colors select-none group whitespace-nowrap" [class.text-right]="isNumericCol(col.key)" [class.text-center]="isCenterCol(col.key)">
                       <div class="flex items-center gap-1" [class.justify-end]="isNumericCol(col.key)" [class.justify-center]="isCenterCol(col.key)">
                          {{ col.label }}
                          <div class="flex flex-col opacity-0 group-hover:opacity-50" [class.opacity-100]="sortConfig().key === col.key">
                             <app-icon name="chevron-down" [size]="10" class="rotate-180 -mb-1" [class.text-teal-600]="sortConfig().key === col.key && sortConfig().direction === 'asc'"></app-icon>
                             <app-icon name="chevron-down" [size]="10" [class.text-teal-600]="sortConfig().key === col.key && sortConfig().direction === 'desc'"></app-icon>
                          </div>
                       </div>
                    </th>
                  }
                  <th class="p-3 font-medium border-b border-slate-100 text-right w-16">Action</th>
                </tr>
              </thead>
              <tbody class="text-sm divide-y divide-slate-50">
                @if (paginatedProducts().length === 0) {
                   <tr>
                     <td [attr.colspan]="visibleColumns().length + 1" class="p-12 text-center text-slate-400">
                       <div class="flex flex-col items-center justify-center gap-2">
                          <app-icon name="search" [size]="32" class="opacity-20"></app-icon>
                          <p>No products found in {{ getBranchName(selectedBranchId()) }}.</p>
                       </div>
                     </td>
                   </tr>
                }
                @for (item of paginatedProducts(); track item.id) {
                  <tr class="group hover:bg-slate-50 transition-colors">
                    @for (col of visibleColumns(); track col.key) {
                      <td class="p-3 whitespace-nowrap" [class.text-right]="isNumericCol(col.key)" [class.text-center]="isCenterCol(col.key)">
                         @if (col.key === 'name') {
                            <div>
                               <div class="font-medium text-slate-700">{{ item.name }}</div>
                               <div class="text-[10px] text-slate-400 font-mono">{{ item.sku }}</div>
                            </div>
                         }
                         @else if (col.key === 'category') {
                            <span class="inline-block px-2 py-0.5 rounded-full bg-slate-100 text-slate-500 text-[10px] uppercase tracking-wide border border-slate-200">
                              {{ item.category }}
                            </span>
                         }
                         @else if (col.key === 'stock') {
                            <div class="flex flex-col items-center">
                              <span 
                                class="px-2 py-0.5 rounded-full font-bold text-[10px] border flex items-center gap-1"
                                [class.bg-red-50]="item.stock === 0" [class.text-red-600]="item.stock === 0" [class.border-red-100]="item.stock === 0"
                                [class.bg-amber-50]="item.stock > 0 && item.stock < item.minStock" [class.text-amber-600]="item.stock > 0 && item.stock < item.minStock" [class.border-amber-100]="item.stock > 0 && item.stock < item.minStock"
                                [class.bg-emerald-50]="item.stock >= item.minStock" [class.text-emerald-600]="item.stock >= item.minStock" [class.border-emerald-100]="item.stock >= item.minStock"
                              >
                                {{ item.stock }}
                              </span>
                            </div>
                         }
                         @else if (col.key === 'supplierId') {
                            <span class="text-slate-500 text-xs">{{ getSupplierName(item.supplierId) }}</span>
                         }
                         @else if (col.key === 'margin') {
                            <span class="text-emerald-600 bg-emerald-50 px-1.5 py-0.5 rounded text-xs">
                               {{ item.margin | number:'1.0-1' }}%
                            </span>
                         }
                         @else {
                            <span class="text-slate-600">{{ getProductValue(item, col.key) | number }}</span>
                         }
                      </td>
                    }
                    <td class="p-3 text-right">
                      <button (click)="openActionMenu($event, item.id)" class="p-1.5 hover:bg-white rounded-lg text-slate-400 hover:text-teal-600 transition-colors border border-transparent hover:border-slate-100 shadow-sm">
                        <app-icon name="more-horizontal" [size]="16"></app-icon>
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          } 
          
          <!-- GRID VIEW -->
          @else {
             <div class="p-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
               @if (paginatedProducts().length === 0) {
                  <div class="col-span-full p-12 text-center text-slate-400 flex flex-col items-center justify-center gap-2">
                      <app-icon name="search" [size]="32" class="opacity-20"></app-icon>
                      <p>No products found matching your criteria.</p>
                  </div>
               }
               @for (item of paginatedProducts(); track item.id) {
                  <div class="bg-white rounded-xl border border-slate-100 shadow-sm hover:border-teal-200 transition-all p-4 flex flex-col group relative">
                     <div class="flex justify-between items-start mb-3">
                        <div class="w-10 h-10 rounded-lg bg-slate-50 border border-slate-100 flex items-center justify-center text-slate-300">
                           <app-icon name="package" [size]="20"></app-icon>
                        </div>
                        <button (click)="openActionMenu($event, item.id)" class="text-slate-300 hover:text-teal-600 transition-colors">
                           <app-icon name="more-horizontal" [size]="18"></app-icon>
                        </button>
                     </div>
                     
                     <h3 class="font-medium text-slate-800 text-sm truncate" title="{{item.name}}">{{ item.name }}</h3>
                     <div class="text-xs text-slate-400 mb-4">{{ item.genericName }}</div>
                     
                     <div class="mt-auto pt-3 border-t border-slate-50 flex items-center justify-between">
                        <div class="flex flex-col">
                           <span class="text-[10px] text-slate-400 uppercase">Stock</span>
                           <span class="text-xs font-bold" 
                             [class.text-red-500]="item.stock === 0" 
                             [class.text-amber-500]="item.stock > 0 && item.stock < item.minStock"
                             [class.text-emerald-500]="item.stock >= item.minStock">
                             {{ item.stock }}
                           </span>
                        </div>
                        <div class="flex flex-col items-end">
                           <span class="text-[10px] text-slate-400 uppercase">Price</span>
                           <span class="text-sm font-medium text-slate-800">{{ item.price | number }}</span>
                        </div>
                     </div>
                  </div>
               }
             </div>
          }
        </div>

        <!-- Pagination Footer -->
        <div class="p-3 border-t border-slate-100 bg-white/50 flex justify-between items-center text-xs text-slate-500">
            <div class="flex items-center gap-2">
               <span>Rows:</span>
               <select [(ngModel)]="pageSize" (change)="currentPage.set(1)" class="bg-transparent border-none focus:ring-0 font-medium text-slate-700 cursor-pointer">
                 <option [value]="10">10</option>
                 <option [value]="25">25</option>
               </select>
               <span class="ml-2">
                 {{ (currentPage() - 1) * pageSize() + 1 }} - {{ Math.min(currentPage() * pageSize(), filteredProducts().length) }} of {{ filteredProducts().length }}
               </span>
            </div>
            <div class="flex items-center gap-1">
               <button (click)="changePage(-1)" [disabled]="currentPage() === 1" class="p-1 rounded hover:bg-slate-200 disabled:opacity-30 disabled:cursor-not-allowed">
                 <app-icon name="arrow-left" [size]="14"></app-icon>
               </button>
               <button (click)="changePage(1)" [disabled]="currentPage() * pageSize() >= filteredProducts().length" class="p-1 rounded hover:bg-slate-200 disabled:opacity-30 disabled:cursor-not-allowed">
                 <app-icon name="arrow-right" [size]="14"></app-icon>
               </button>
            </div>
        </div>
      </div>

      <!-- REDESIGNED ADD/EDIT MODAL -->
      @if (showModal()) {
        <div class="absolute inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm animate-fade-in p-4" (click)="closeModal()">
           
           <div class="bg-white rounded-2xl shadow-2xl w-full max-w-[95%] h-[90vh] flex flex-col border border-slate-200 overflow-hidden" (click)="$event.stopPropagation()">
              
              <!-- Header -->
              <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/80 backdrop-blur shrink-0">
                 <div>
                    <h3 class="text-xl font-bold text-slate-800 tracking-tight">{{ editingId ? 'Edit Product' : 'Inventory Ingestion' }}</h3>
                    <p class="text-xs text-slate-500 font-medium">Adding stock to: <strong>{{ getBranchName(selectedBranchId()) }}</strong></p>
                 </div>
                 <button (click)="closeModal()" class="p-2 rounded-full hover:bg-red-50 text-slate-400 hover:text-red-500 transition-colors">
                    <app-icon name="x" [size]="20"></app-icon>
                 </button>
              </div>

              <div class="flex-1 flex overflow-hidden">
                 
                 <!-- COLUMN 1: SOURCE SELECTION (PROGRESSIVE) -->
                 @if (!editingId) {
                    <div class="w-72 bg-slate-50/50 border-r border-slate-100 flex flex-col shrink-0">
                       <div class="p-4 border-b border-slate-100">
                          <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2 mb-3">
                             <app-icon name="database" [size]="14"></app-icon> Source Document
                          </h4>
                          
                          <!-- Step 1: Supplier Selection -->
                          <div class="mb-3">
                             <label class="block text-[10px] font-medium text-slate-400 mb-1 uppercase">Step 1: Supplier</label>
                             <select [ngModel]="sourceSupplierId()" (ngModelChange)="onSupplierChange($event)" class="glass-input w-full px-3 py-2 rounded-lg text-sm bg-white border-slate-200">
                                <option value="">-- Select Supplier --</option>
                                @for(s of store.suppliers(); track s.id) {
                                   <option [value]="s.id">{{ s.name }}</option>
                                }
                             </select>
                          </div>
                       </div>
                       
                       <div class="flex-1 overflow-y-auto bg-slate-50/30">
                          @if (!sourceSupplierId()) {
                             <!-- Instruction State -->
                             <div class="flex flex-col items-center justify-center h-48 px-6 text-center text-slate-400">
                                <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mb-3">
                                   <app-icon name="users" [size]="24" class="opacity-50"></app-icon>
                                </div>
                                <p class="text-xs font-medium">Select a supplier to view orders for {{ getBranchName(selectedBranchId()) }}.</p>
                             </div>
                          } @else {
                             <!-- Step 2: PO Selection List with State Badges -->
                             <div class="p-2 space-y-1">
                                <div class="px-2 py-1 text-[10px] font-bold text-slate-400 uppercase">Available Orders</div>
                                @if (filteredPOs().length === 0) {
                                   <div class="p-4 text-xs text-center text-slate-400 italic bg-white rounded-lg border border-dashed border-slate-200 mx-2">
                                      No Orders found for this supplier & branch.
                                   </div>
                                }
                                @for (po of filteredPOs(); track po.id) {
                                   <button (click)="selectPO(po)" 
                                      [disabled]="getPOStatus(po) === 'Unbilled'"
                                      class="w-full text-left p-3 rounded-lg border transition-all group relative overflow-hidden flex flex-col gap-1"
                                      [class]="selectedSourcePO()?.id === po.id ? 'bg-white border-teal-500 shadow-md ring-1 ring-teal-500 z-10' : 'bg-white border-slate-200 hover:border-teal-300 hover:bg-slate-50 disabled:opacity-60 disabled:cursor-not-allowed disabled:hover:border-slate-200'">
                                      
                                      <div class="flex justify-between items-center w-full">
                                         <span class="font-bold text-xs text-slate-700">{{ po.id }}</span>
                                         <span class="text-[10px] text-slate-400">{{ po.date | date:'shortDate' }}</span>
                                      </div>
                                      
                                      <!-- Status Badge Logic -->
                                      <div class="flex items-center justify-between w-full mt-1">
                                         <span class="text-[9px] px-1.5 py-0.5 rounded font-medium truncate"
                                            [class.bg-teal-50]="getPOStatus(po) === 'Pending'" [class.text-teal-700]="getPOStatus(po) === 'Pending'"
                                            [class.bg-amber-50]="getPOStatus(po) === 'Unbilled'" [class.text-amber-700]="getPOStatus(po) === 'Unbilled'"
                                            [class.bg-slate-100]="getPOStatus(po) === 'Fully Added'" [class.text-slate-500]="getPOStatus(po) === 'Fully Added'">
                                            @if(getPOStatus(po) === 'Pending') { BILLED & PENDING }
                                            @else if(getPOStatus(po) === 'Unbilled') { UNBILLED PO }
                                            @else { FULLY ADDED }
                                         </span>
                                         <span class="text-[10px] text-slate-400">{{ po.items.length }} Items</span>
                                      </div>
                                   </button>
                                }
                             </div>
                          }
                       </div>
                    </div>
                 }

                 <!-- COLUMN 2: INGESTION WORKSPACE (MIDDLE) -->
                 @if (selectedSourcePO() && !editingId) {
                    <div class="flex-1 flex flex-col bg-white border-r border-slate-100 min-w-0 animate-fade-in">
                       <!-- Summary Header -->
                       <div class="p-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                          <div>
                             <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">
                                {{ selectedSourcePO()!.id }} â€¢ {{ getSupplierName(selectedSourcePO()!.supplierId) }}
                             </div>
                             <div class="text-sm font-medium text-slate-800">
                                {{ selectedSourcePO()!.items.length }} Items Found â€¢ {{ selectedPOItems.size }} Selected
                             </div>
                          </div>
                          <div class="flex gap-2">
                             <input type="text" [(ngModel)]="ingestSearch" placeholder="Filter items..." class="glass-input px-3 py-1.5 rounded-lg text-xs bg-white w-40">
                          </div>
                       </div>

                       <!-- High Density Table -->
                       <div class="flex-1 overflow-auto">
                          <table class="w-full text-left text-sm">
                             <thead class="bg-slate-50 text-[10px] uppercase text-slate-500 font-bold sticky top-0 z-10 shadow-sm">
                                <tr>
                                   <th class="p-3 w-10 text-center">
                                      <input type="checkbox" [checked]="isAllSelected()" (change)="toggleSelectAll()" [disabled]="isCurrentPOFullyAdded()" class="rounded text-teal-600 focus:ring-teal-500 cursor-pointer disabled:opacity-50">
                                   </th>
                                   <th class="p-3">Product Description</th>
                                   <th class="p-3 text-right">Qty</th>
                                   <th class="p-3 text-right">Unit Cost</th>
                                   <th class="p-3 text-center w-24">Status</th>
                                   <th class="p-3 w-10"></th>
                                </tr>
                             </thead>
                             <tbody class="divide-y divide-slate-50">
                                @for (item of filteredPOItems(); track item.productId) {
                                   <tr class="hover:bg-teal-50/30 transition-colors group cursor-pointer" 
                                       [class.bg-teal-50]="activePOItem() === item"
                                       [class.ring-2]="activePOItem() === item"
                                       [class.ring-teal-500]="activePOItem() === item"
                                       [class.ring-inset]="activePOItem() === item"
                                       (click)="handleRowClick(item)">
                                      <td class="p-3 text-center">
                                         <input type="checkbox" [checked]="selectedPOItems.has(item)" [disabled]="isCurrentPOFullyAdded()" class="rounded text-teal-600 focus:ring-teal-500 cursor-pointer pointer-events-none disabled:opacity-50">
                                      </td>
                                      <td class="p-3">
                                         <div class="font-medium text-slate-800">{{ getProductName(item.productId) }}</div>
                                         <div class="text-[10px] text-slate-400 font-mono">{{ item.productId }}</div>
                                      </td>
                                      <td class="p-3 text-right font-mono">{{ item.quantity }}</td>
                                      <td class="p-3 text-right font-mono text-slate-600">{{ item.unitCost | number }}</td>
                                      <td class="p-3 text-center">
                                         @if (isProductInSystem(item.productId)) {
                                            <span class="inline-flex px-2 py-0.5 rounded-full text-[9px] font-bold bg-blue-50 text-blue-600 border border-blue-100">STOCK</span>
                                         } @else {
                                            <span class="inline-flex px-2 py-0.5 rounded-full text-[9px] font-bold bg-amber-50 text-amber-600 border border-amber-100">NEW</span>
                                         }
                                      </td>
                                      <td class="p-3 text-center">
                                         <app-icon name="chevron-right" [size]="14" class="text-slate-300 group-hover:text-teal-500"></app-icon>
                                      </td>
                                   </tr>
                                }
                             </tbody>
                          </table>
                       </div>

                       <!-- Bulk Action Footer -->
                       @if (!isCurrentPOFullyAdded() && selectedPOItems.size > 0) {
                          <div class="p-3 border-t border-slate-100 bg-slate-900 text-white flex justify-between items-center shadow-lg animate-fade-in">
                             <div class="text-xs font-medium pl-2">{{ selectedPOItems.size }} items selected for import</div>
                             <button (click)="importBatch()" class="px-4 py-1.5 bg-teal-500 hover:bg-teal-600 text-white rounded-lg text-xs font-bold transition-all shadow flex items-center gap-2">
                                <app-icon name="download" [size]="14"></app-icon> Import Selection
                             </button>
                          </div>
                       }
                    </div>
                 }

                 <!-- COLUMN 3: CONTEXTUAL EDITOR (RIGHT) -->
                 <!-- Only visible if an item is actively selected for editing -->
                 @if (activePOItem() || editingId) {
                    <div class="flex-1 flex flex-col min-w-0 bg-slate-50/30 overflow-y-auto p-6 relative border-l border-slate-100 animate-fade-in-right">
                        
                        @if (isCurrentPOFullyAdded() && !editingId) {
                           <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mb-4 rounded-r shadow-sm">
                              <div class="flex items-center gap-2">
                                 <app-icon name="check-circle" [size]="16" class="text-blue-600"></app-icon>
                                 <p class="text-xs text-blue-800 font-bold">Read Only Mode</p>
                              </div>
                              <p class="text-[10px] text-blue-600 mt-1 pl-6">This order is already fully imported. You can view details and trends but cannot edit.</p>
                           </div>
                        }

                        <!-- Form Content -->
                        <div class="space-y-6 max-w-2xl mx-auto w-full">
                           <!-- ... Content omitted for brevity, same as previous ... -->
                           <!-- Procurement Source Card -->
                           @if (activePOItem() || getLinkedBill()) {
                              <div class="bg-white rounded-xl border border-blue-100 shadow-sm p-4 relative overflow-hidden group">
                                 <div class="absolute top-0 left-0 w-1 h-full bg-blue-500"></div>
                                 <div class="flex justify-between items-start">
                                    <div>
                                       <h4 class="text-xs font-bold text-blue-600 uppercase tracking-wider mb-1 flex items-center gap-2">
                                          <app-icon name="file-text" [size]="14"></app-icon> Procurement Source
                                       </h4>
                                       <div class="flex items-center gap-3 mt-2">
                                          <div>
                                             <div class="text-[10px] text-slate-400 uppercase">PO Number</div>
                                             <div class="text-sm font-bold text-slate-800">{{ selectedSourcePO()?.id || newProduct.initialPoRef }}</div>
                                          </div>
                                          <div class="h-6 w-px bg-slate-100"></div>
                                          @if (getLinkedBill(); as bill) {
                                             <div>
                                                <div class="text-[10px] text-slate-400 uppercase">Linked Invoice</div>
                                                <div class="text-sm font-medium text-slate-700 flex items-center gap-2">
                                                   {{ bill.billNumber }}
                                                   <span class="px-1.5 py-0.5 rounded text-[9px] font-bold uppercase"
                                                      [class.bg-emerald-100]="bill.status === 'Paid'" [class.text-emerald-700]="bill.status === 'Paid'"
                                                      [class.bg-amber-100]="bill.status !== 'Paid'" [class.text-amber-700]="bill.status !== 'Paid'">
                                                      {{ bill.status }}
                                                   </span>
                                                </div>
                                             </div>
                                          }
                                       </div>
                                    </div>
                                    @if (getLinkedBill()) {
                                       <button class="text-xs bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg font-medium hover:bg-blue-100 transition-colors">
                                          View Bill
                                       </button>
                                    }
                                 </div>
                              </div>
                           }

                           <!-- Product Identity -->
                           <fieldset class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm">
                              <legend class="px-2 text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                                 <app-icon name="package" [size]="14"></app-icon> Product Definition
                              </legend>
                              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
                                 <div class="md:col-span-2">
                                    <label class="block text-xs font-medium text-slate-700 mb-1">Product Name <span class="text-red-500">*</span></label>
                                    <input type="text" [(ngModel)]="newProduct.name" [readonly]="isCurrentPOFullyAdded()" class="glass-input w-full px-3 py-2 rounded-lg text-sm font-medium border-slate-200 focus:ring-teal-500/20 read-only:bg-slate-50 read-only:text-slate-500">
                                 </div>
                                 <div>
                                    <label class="block text-xs font-medium text-slate-700 mb-1">SKU / Barcode</label>
                                    <input type="text" [(ngModel)]="newProduct.sku" [readonly]="isCurrentPOFullyAdded()" class="glass-input w-full px-3 py-2 rounded-lg text-sm border-slate-200 read-only:bg-slate-50 read-only:text-slate-500">
                                 </div>
                                 <div>
                                    <label class="block text-xs font-medium text-slate-700 mb-1">Category</label>
                                    <select [(ngModel)]="newProduct.category" [disabled]="isCurrentPOFullyAdded()" class="glass-input w-full px-3 py-2 rounded-lg text-sm border-slate-200 bg-white disabled:bg-slate-50 disabled:text-slate-500">
                                       <option value="Analgesic">Analgesic</option>
                                       <option value="Antibiotic">Antibiotic</option>
                                       <option value="General">General</option>
                                    </select>
                                 </div>
                              </div>
                           </fieldset>

                           <!-- Pricing & Intelligence Card -->
                           <div class="grid grid-cols-1 gap-4">
                              <fieldset class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm relative overflow-hidden">
                                 <legend class="px-2 text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                                    <app-icon name="dollar-sign" [size]="14"></app-icon> Pricing Logic
                                 </legend>
                                 <div class="grid grid-cols-2 gap-4 mt-2">
                                    <div>
                                       <label class="block text-xs font-medium text-slate-600 mb-1">Unit Cost</label>
                                       <input type="number" [(ngModel)]="newProduct.cost" (ngModelChange)="recalcPrice()" readonly 
                                          class="glass-input w-full px-3 py-2 rounded-lg text-sm bg-slate-50 border-slate-200 font-bold text-slate-600 cursor-not-allowed">
                                    </div>
                                    <div>
                                       <label class="block text-xs font-medium text-slate-600 mb-1">Selling Price</label>
                                       <div class="relative">
                                          <div class="absolute inset-y-0 right-0 flex items-center px-3 text-slate-400 text-xs">YER</div>
                                          <input type="number" [ngModel]="newProduct.price" readonly class="glass-input w-full px-3 py-2 rounded-lg text-lg font-bold text-teal-600 bg-white border-slate-200">
                                       </div>
                                    </div>
                                    <div class="col-span-2">
                                       <label class="block text-xs font-medium text-slate-600 mb-1">Margin %</label>
                                       <div class="flex items-center gap-2">
                                          <input type="number" [(ngModel)]="newProduct.margin" (ngModelChange)="recalcPrice()" min="0" [readonly]="isCurrentPOFullyAdded()" 
                                             class="glass-input w-20 px-2 py-1.5 rounded-lg text-sm border-teal-300 focus:ring-teal-500 font-bold text-teal-700 text-center read-only:bg-slate-50 read-only:text-slate-500">
                                          <input type="range" [(ngModel)]="newProduct.margin" (ngModelChange)="recalcPrice()" min="0" max="100" [disabled]="isCurrentPOFullyAdded()" class="flex-1 accent-teal-500 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer disabled:opacity-50">
                                       </div>
                                    </div>
                                 </div>
                              </fieldset>

                              <!-- Advanced Cost Intelligence Card -->
                              <div class="bg-slate-800 rounded-xl p-4 text-white shadow-xl relative overflow-hidden flex flex-col justify-between min-h-[220px]">
                                 <div class="absolute top-0 right-0 p-3 opacity-10">
                                    <app-icon name="trending-up" [size]="64"></app-icon>
                                 </div>
                                 
                                 <!-- Header Stats -->
                                 <div class="flex justify-between items-start z-10 mb-4">
                                    <div>
                                       <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">6-Month Avg</div>
                                       <div class="text-xl font-bold">{{ pricingHistory().avg | number:'1.2-2' }}</div>
                                    </div>
                                    <div class="text-right">
                                       <div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Trend</div>
                                       <div class="flex items-center justify-end gap-1 font-bold" 
                                          [class.text-emerald-400]="pricingHistory().trend <= 0" 
                                          [class.text-red-400]="pricingHistory().trend > 0">
                                          <span class="text-lg">{{ pricingHistory().trend > 0 ? 'â†—' : 'â†˜' }} {{ Math.abs(pricingHistory().trend) }}%</span>
                                       </div>
                                    </div>
                                 </div>

                                 <!-- Dot Plot Visualization -->
                                 <div class="flex-1 relative w-full h-24 mb-2">
                                    <svg width="100%" height="100%" class="overflow-visible">
                                       <!-- Grid Lines -->
                                       <line x1="0" y1="50%" x2="100%" y2="50%" stroke="rgba(255,255,255,0.1)" stroke-dasharray="3,3" />
                                       
                                       <!-- Trend Line -->
                                       <path [attr.d]="pricingHistory().sparkline" fill="none" stroke="rgba(94, 234, 212, 0.5)" stroke-width="2" />
                                       
                                       <!-- Data Points with Tooltips -->
                                       @for (point of pricingHistory().points; track $index) {
                                          <circle [attr.cx]="point.x" [attr.cy]="point.y" r="4" fill="#2dd4bf" stroke="#1e293b" stroke-width="2" class="hover:r-6 transition-all cursor-pointer">
                                             <title>{{ point.date }} â€¢ Cost: {{ point.val | number }}</title>
                                          </circle>
                                       }
                                       
                                       <!-- Current Point -->
                                       <circle [attr.cx]="pricingHistory().lastX" [attr.cy]="pricingHistory().lastY" r="5" fill="#f43f5e" stroke="#fff" stroke-width="2" />
                                    </svg>
                                 </div>

                                 <!-- Generated Insight -->
                                 <div class="text-xs text-slate-300 font-medium bg-white/10 p-2 rounded-lg backdrop-blur-sm border border-white/5 flex items-start gap-2">
                                    <app-icon name="alert-circle" [size]="14" class="text-teal-400 mt-0.5 shrink-0"></app-icon>
                                    {{ pricingHistory().insight }}
                                 </div>
                              </div>
                           </div>

                           <!-- Stock -->
                           <fieldset class="bg-white border border-slate-200 rounded-xl p-5 shadow-sm">
                              <legend class="px-2 text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-2">
                                 <app-icon name="truck" [size]="14"></app-icon> Stock & Expiry
                              </legend>
                              <div class="grid grid-cols-2 gap-4 mt-2">
                                 <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1">Incoming Qty</label>
                                    <input type="number" [(ngModel)]="newStockQty" readonly class="glass-input w-full px-3 py-2 rounded-lg text-sm bg-slate-50 font-bold text-slate-700">
                                 </div>
                                 <div>
                                    <label class="block text-xs font-medium text-slate-600 mb-1">Expiry Date</label>
                                    <input type="date" [(ngModel)]="newProduct.expiryDate" [readonly]="isCurrentPOFullyAdded()" class="glass-input w-full px-3 py-2 rounded-lg text-sm border-slate-200 read-only:bg-slate-50 read-only:text-slate-500">
                                 </div>
                              </div>
                           </fieldset>

                           @if (!isCurrentPOFullyAdded() || editingId) {
                              <div class="pt-4 flex gap-3 justify-end">
                                 <button (click)="saveProduct()" [disabled]="!isValid()" class="px-6 py-2.5 bg-slate-800 text-white rounded-lg shadow-lg hover:bg-slate-700 transition-all font-medium text-sm flex items-center gap-2">
                                    <app-icon name="check" [size]="16"></app-icon> 
                                    {{ editingId ? 'Update' : 'Confirm Import' }}
                                 </button>
                              </div>
                           }
                        </div>
                    </div>
                 } @else if (selectedSourcePO() && !activePOItem()) {
                    <!-- Empty State for Col 3 -->
                    <div class="flex-1 flex flex-col items-center justify-center text-center p-8 opacity-50 bg-slate-50/30 border-l border-slate-100">
                        <app-icon name="package" [size]="48" class="mb-4 text-slate-300"></app-icon>
                        <p class="text-sm font-medium text-slate-500">Select a product from the list to view details.</p>
                    </div>
                 }
              </div>
           </div>
        </div>
      }

      } <!-- End of else block for products display -->

      <!-- Action Menu Overlay -->
      @if (activeActionRow()) {
         <div 
           class="fixed z-50 bg-white rounded-lg shadow-xl border border-slate-100 py-1 w-40 text-left animate-fade-in"
           [style.top.px]="actionMenuPosition().y"
           [style.left.px]="actionMenuPosition().x"
           (click)="$event.stopPropagation()"
           role="menu"
           aria-label="Product actions"
         >
            <button (click)="editProduct(activeActionRow()!)" class="w-full text-left px-4 py-2 text-xs text-slate-600 hover:bg-slate-50 hover:text-teal-600 flex items-center gap-2" role="menuitem">
              <app-icon name="edit-3" [size]="14"></app-icon> Edit Details
            </button>
            <div class="h-px bg-slate-100 my-1" role="separator"></div>
            <button (click)="deleteProduct(activeActionRow()!)" class="w-full text-left px-4 py-2 text-xs text-red-500 hover:bg-red-50 flex items-center gap-2" role="menuitem">
              <app-icon name="trash-2" [size]="14"></app-icon> Delete
            </button>
         </div>
      }
    </div>

