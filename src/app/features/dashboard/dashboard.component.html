<div class="h-full flex flex-col gap-6 animate-fade-in overflow-y-auto pr-2" role="main" aria-label="Dashboard">
  
  <!-- Header -->
  <header class="flex justify-between items-center mb-2 shrink-0">
    <div>
      <h1 class="text-2xl font-semibold tracking-tight text-slate-800">Dashboard</h1>
      <p class="text-sm text-slate-500 font-normal mt-1">
        @if (store.activeBranch(); as branch) {
          {{ branch.name }} • <span class="text-teal-600 font-medium">Live</span>
        } @else {
          <span class="text-amber-600">No branch configured</span>
        }
      </p>
    </div>
    
    @if (!store.isFirstTimeUser()) {
      <div class="flex gap-2">
        <button 
          class="px-4 py-2 bg-white hover:bg-slate-50 border border-slate-200 text-slate-600 rounded-lg text-sm font-medium transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2"
          aria-label="Export dashboard report"
        >
          Export Report
        </button>
      </div>
    }
  </header>

  <!-- Unified Getting Started Card -->
  @if (showGettingStarted()) {
    <section 
      class="getting-started-card shrink-0"
      aria-labelledby="getting-started-title"
      role="region"
    >
      <!-- Header Section -->
      <div class="card-header">
        <div class="header-content">
          <div class="icon-container" [class.complete]="isSetupComplete()">
            @if (isSetupComplete()) {
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            } @else {
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4.5 16.5c-1.5 1.26-2 5-2 5s3.74-.5 5-2c.71-.84.7-2.13-.09-2.91a2.18 2.18 0 0 0-2.91-.09z"></path>
                <path d="m12 15-3-3a22 22 0 0 1 2-3.95A12.88 12.88 0 0 1 22 2c0 2.72-.78 7.5-6 11a22.35 22.35 0 0 1-4 2z"></path>
                <path d="M9 12H4s.55-3.03 2-4c1.62-1.08 5 0 5 0"></path>
                <path d="M12 15v5s3.03-.55 4-2c1.08-1.62 0-5 0-5"></path>
              </svg>
            }
          </div>
          <div class="header-text">
            <h2 id="getting-started-title" class="title">
              @if (isSetupComplete()) {
                You're all set!
              } @else {
                Welcome to {{ store.tenant()?.name || 'Thurayya' }}
              }
            </h2>
            <p class="subtitle">
              @if (isSetupComplete()) {
                Your pharmacy is ready. Start managing your inventory.
              } @else {
                Complete these steps to unlock your dashboard.
              }
            </p>
          </div>
        </div>
        
        @if (!isSetupComplete()) {
          <div class="progress-section" role="progressbar" [attr.aria-valuenow]="overallProgress()" aria-valuemin="0" aria-valuemax="100" [attr.aria-label]="'Setup progress: ' + overallProgress() + '% complete'">
            <div class="progress-ring">
              <svg viewBox="0 0 36 36">
                <defs>
                  <linearGradient id="progress-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#14b8a6" />
                    <stop offset="100%" stop-color="#0d9488" />
                  </linearGradient>
                </defs>
                <path class="ring-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                <path class="ring-fill" [attr.stroke-dasharray]="overallProgress() + ', 100'" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
              </svg>
              <span class="progress-text">{{ overallProgress() }}%</span>
            </div>
          </div>
        }
        
        <button 
          (click)="dismissGettingStarted()" 
          class="dismiss-btn"
          aria-label="Dismiss getting started guide"
          title="Hide this guide"
        >
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <!-- Steps or Actions -->
      @if (isSetupComplete()) {
        <!-- Completed State: Quick Actions -->
        <div class="complete-actions">
          <button 
            (click)="store.setView('inventory')"
            class="action-btn primary"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="m7.5 4.27 9 5.15"></path>
              <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"></path>
              <path d="m3.3 7 8.7 5 8.7-5"></path>
              <path d="M12 22V12"></path>
            </svg>
            <span>Add Products</span>
          </button>
          <button 
            (click)="store.setView('procurement-suppliers')"
            class="action-btn secondary"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"></path>
              <path d="M15 18H9"></path>
              <path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"></path>
              <circle cx="17" cy="18" r="2"></circle>
              <circle cx="7" cy="18" r="2"></circle>
            </svg>
            <span>Add Suppliers</span>
          </button>
          <button 
            (click)="store.setView('pos')"
            class="action-btn secondary"
          >
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect width="20" height="14" x="2" y="5" rx="2"></rect>
              <line x1="2" x2="22" y1="10" y2="10"></line>
            </svg>
            <span>Open POS</span>
          </button>
        </div>
      } @else {
        <!-- Setup Steps -->
        <div class="steps-grid" role="list" aria-label="Setup steps">
          @for (step of allSetupSteps(); track step.id; let i = $index) {
            <button 
              class="step-item" 
              [class.done]="step.done"
              [class.actionable]="!step.done && step.action"
              [class.locked]="!step.done && !step.action"
              [disabled]="!step.action || step.done"
              (click)="handleStepClick(step)"
              role="listitem"
              [attr.aria-label]="step.label + (step.done ? ' - Completed' : step.action ? ' - Click to start' : ' - Locked')"
            >
              <div class="step-indicator">
                @if (step.done) {
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                } @else {
                  <span>{{ i + 1 }}</span>
                }
              </div>
              <div class="step-content">
                <span class="step-label">{{ step.label }}</span>
                @if (!step.done && step.action) {
                  <span class="step-cta">Start →</span>
                } @else if (step.done) {
                  <span class="step-status">Done</span>
                } @else {
                  <span class="step-locked">Locked</span>
                }
              </div>
            </button>
          }
        </div>
      }
    </section>
  }
  
  <!-- Stats Grid - Always visible -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 shrink-0" role="group" aria-label="Key metrics">
      
      <!-- Sales Today -->
      <article class="glass-panel p-5 rounded-xl flex flex-col justify-between group hover:border-teal-300/50 transition-colors duration-300">
        <div class="flex justify-between items-start">
          <div class="p-2.5 bg-teal-50 rounded-xl text-teal-600 group-hover:scale-110 transition-transform">
            <app-icon name="trending-up" [size]="20"></app-icon>
          </div>
          @if (!store.isFirstTimeUser()) {
            <span class="text-xs font-medium text-emerald-600 bg-emerald-50 px-2 py-1 rounded-full">+12.5%</span>
          }
        </div>
        <div class="mt-4">
          @if (store.isFirstTimeUser()) {
            <h3 class="text-2xl font-semibold text-slate-400">--</h3>
            <p class="text-sm text-slate-400 mt-1">No sales yet</p>
          } @else {
            <h3 class="text-2xl font-semibold text-slate-800">243,500 <span class="text-sm font-normal text-slate-400">YER</span></h3>
            <p class="text-sm text-slate-500 mt-1">Total Sales Today</p>
          }
        </div>
      </article>

      <!-- Stock Value -->
      <article class="glass-panel p-5 rounded-xl flex flex-col justify-between group hover:border-blue-300/50 transition-colors duration-300">
        <div class="flex justify-between items-start">
          <div class="p-2.5 bg-blue-50 rounded-xl text-blue-600 group-hover:scale-110 transition-transform">
            <app-icon name="package" [size]="20"></app-icon>
          </div>
        </div>
        <div class="mt-4">
          @if (store.products().length === 0) {
            <h3 class="text-2xl font-semibold text-slate-400">--</h3>
            <p class="text-sm text-slate-400 mt-1">No inventory</p>
          } @else {
            <h3 class="text-2xl font-semibold text-slate-800">{{ store.totalStockValue() | number }} <span class="text-sm font-normal text-slate-400">YER</span></h3>
            <p class="text-sm text-slate-500 mt-1">Total Stock Value</p>
          }
        </div>
      </article>

      <!-- Low Stock -->
      <article class="glass-panel p-5 rounded-xl flex flex-col justify-between group hover:border-amber-300/50 transition-colors duration-300">
        <div class="flex justify-between items-start">
          <div class="p-2.5 bg-amber-50 rounded-xl text-amber-600 group-hover:scale-110 transition-transform">
            <app-icon name="alert-circle" [size]="20"></app-icon>
          </div>
          @if (store.lowStockItems().length > 0) {
            <span class="text-xs font-medium text-amber-600 bg-amber-50 px-2 py-1 rounded-full">
              {{ store.lowStockItems().length }} {{ store.lowStockItems().length === 1 ? 'Item' : 'Items' }}
            </span>
          }
        </div>
        <div class="mt-4">
          @if (store.products().length === 0) {
            <h3 class="text-2xl font-semibold text-slate-400">--</h3>
            <p class="text-sm text-slate-400 mt-1">Add inventory first</p>
          } @else if (store.lowStockItems().length === 0) {
            <h3 class="text-2xl font-semibold text-emerald-600">All Good</h3>
            <p class="text-sm text-slate-500 mt-1">Stock levels healthy</p>
          } @else {
            <h3 class="text-2xl font-semibold text-amber-600">Low Stock</h3>
            <p class="text-sm text-slate-500 mt-1">Needs attention</p>
          }
        </div>
      </article>

      <!-- Team Members -->
      <article class="glass-panel p-5 rounded-xl flex flex-col justify-between group hover:border-purple-300/50 transition-colors duration-300">
        <div class="flex justify-between items-start">
          <div class="p-2.5 bg-purple-50 rounded-xl text-purple-600 group-hover:scale-110 transition-transform">
            <app-icon name="users" [size]="20"></app-icon>
          </div>
        </div>
        <div class="mt-4">
          <h3 class="text-2xl font-semibold text-slate-800">{{ store.users().length || 1 }}</h3>
          <p class="text-sm text-slate-500 mt-1">Team {{ store.users().length === 1 ? 'Member' : 'Members' }}</p>
        </div>
      </article>
    </div>

    <!-- Main Chart Area -->
    <section class="flex-1 glass-panel rounded-xl p-6 flex flex-col min-h-[300px]" aria-labelledby="revenue-chart-title">
      <h3 id="revenue-chart-title" class="text-lg font-semibold text-slate-800 mb-4">Revenue Trend (7 Days)</h3>
      
      @if (store.isFirstTimeUser()) {
        <!-- Empty Chart State -->
        <div class="flex-1 flex items-center justify-center">
          <div class="text-center">
            <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-slate-100 flex items-center justify-center">
              <app-icon name="trending-up" [size]="32" class="text-slate-400"></app-icon>
            </div>
            <h4 class="text-lg font-medium text-slate-600 mb-1">No sales data yet</h4>
            <p class="text-sm text-slate-400 max-w-xs">
              Start making sales to see your revenue trends and analytics here.
            </p>
          </div>
        </div>
      } @else {
        <div class="flex-1 w-full">
          <app-sales-chart></app-sales-chart>
        </div>
      }
    </section>
</div>
