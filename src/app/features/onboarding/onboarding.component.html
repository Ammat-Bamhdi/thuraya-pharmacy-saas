<div class="onboarding" [dir]="dir()">
  <!-- Top Bar -->
  <header class="top-bar">
    <div class="logo">
      <div class="logo-icon">T</div>
      <span>Thurayya</span>
    </div>
    <div class="top-actions">
      <button (click)="logout()" class="icon-btn" title="Sign Out">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
          <polyline points="16 17 21 12 16 7"/>
          <line x1="21" y1="12" x2="9" y2="12"/>
        </svg>
      </button>
      <button (click)="setLang(language() === 'en' ? 'ar' : 'en')" class="lang-btn">
        {{ language() === 'en' ? 'عربي' : 'EN' }}
      </button>
    </div>
  </header>

  <!-- Progress Dots -->
  <div class="progress-dots">
    @for (s of [1,2,3,4]; track s) {
      <div class="dot" [class.active]="step() === s" [class.completed]="step() > s"></div>
    }
  </div>

  <!-- Main Content -->
  <main class="content">
    
    <!-- Step 1: Organization -->
    @if (step() === 1) {
      <div class="step-content">
        <div class="step-header">
          <h1>{{ t().org.title }}</h1>
          <p>{{ t().org.subtitle }}</p>
        </div>

        <div class="form-stack">
          <div class="field">
            <label>{{ t().org.name }}</label>
            <input type="text" [(ngModel)]="tenantName" placeholder="Acme Pharmacy" autofocus>
          </div>

          <div class="field-row">
            <div class="field">
              <label>{{ t().org.country }}</label>
              <select [(ngModel)]="country">
                @for (c of countriesList; track c.value) {
                  <option [value]="c.value">{{ getLocalizedLabel(c) }}</option>
                }
              </select>
            </div>
            <div class="field">
              <label>{{ t().org.currency }}</label>
              <select [(ngModel)]="currency">
                @for (c of currenciesList; track c.value) {
                  <option [value]="c.value">{{ getLocalizedLabel(c) }}</option>
                }
              </select>
            </div>
          </div>

          <button (click)="nextStep()" [disabled]="!tenantName" class="primary-btn">
            {{ t().org.continue }}
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/>
            </svg>
          </button>
        </div>
      </div>
    }

    <!-- Step 2: Branches -->
    @if (step() === 2) {
      <div class="step-content">
        <div class="step-header">
          <h1>{{ t().branch.title }}</h1>
          <p>{{ t().branch.subtitle }}</p>
        </div>

        <div class="tabs">
          <button (click)="branchBulkMode.set(false)" [class.active]="!branchBulkMode()">{{ t().branch.single }}</button>
          <button (click)="branchBulkMode.set(true)" [class.active]="branchBulkMode()">{{ t().branch.bulk }}</button>
        </div>

        <div class="form-stack">
          @if (!branchBulkMode()) {
            <div class="field-row">
              <div class="field">
                <label>{{ t().branch.name }}</label>
                <input type="text" [(ngModel)]="inputBranchName" [placeholder]="t().branch.namePH" (keydown.enter)="addLocalBranch()">
              </div>
              <div class="field">
                <label>{{ t().branch.loc }}</label>
                <input type="text" [(ngModel)]="inputBranchLocation" [placeholder]="t().branch.locPH" 
                       list="cityList" (keydown.enter)="addLocalBranch()" (input)="validateCity()" [class.error]="cityError()">
                <datalist id="cityList">
                  @for (city of availableCities(); track city) {
                    <option [value]="city"></option>
                  }
                </datalist>
              </div>
            </div>
            @if (cityError()) {
              <p class="error-text">{{ t().branch.invalidCity }}</p>
            }
            <button (click)="addLocalBranch()" [disabled]="!inputBranchName || !inputBranchLocation || cityError()" class="secondary-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
              </svg>
              {{ t().branch.add }}
            </button>
          } @else {
            <div class="dropzone">
              <input type="file" (change)="handleBranchFile($event)" accept=".xlsx, .xls, .csv">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <span>{{ t().branch.bulkPH }}</span>
              <span class="hint">{{ t().branch.bulkColumns }}</span>
            </div>
            <button (click)="downloadBranchSample()" class="link-btn">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              {{ t().branch.downloadSample }}
            </button>
          }

          <!-- Branch List with Large List Optimization -->
          @if (branchList().length > 0) {
            <div class="list-section">
              <div class="list-header">
                <span><strong>{{ branchList().length }}</strong> {{ branchList().length === 1 ? 'branch' : 'branches' }} added</span>
                @if (hasManyBranches()) {
                  <button class="list-toggle" (click)="showBranchList.set(!showBranchList())">
                    {{ showBranchList() ? 'Hide list' : 'Show list' }}
                  </button>
                }
              </div>
              
              @if (showBranchList()) {
                <div class="item-list" [class.large]="hasManyBranches()">
                  @for (branch of branchDisplayList(); track $index) {
                    <div class="item">
                      <span class="item-num">{{ $index + 1 }}</span>
                      <div class="item-content">
                        <span class="item-name">{{ branch.name }}</span>
                        <span class="item-meta">{{ branch.location }}</span>
                      </div>
                      <button (click)="removeLocalBranch($index)" class="remove-btn">×</button>
                    </div>
                  }
                  @if (branchList().length > 5 && showBranchList()) {
                    <div class="list-more">
                      +{{ branchList().length - 5 }} more branches
                    </div>
                  }
                </div>
              } @else {
                <div class="list-summary">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                  </svg>
                  <strong>{{ branchList().length }}</strong> branches ready
                </div>
              }
            </div>
          } @else {
            <div class="empty">{{ t().branch.listEmpty }}</div>
          }
        </div>

        <div class="step-footer">
          <button (click)="step.set(1)" class="back-btn">← {{ t().branch.back }}</button>
          <button (click)="nextStep()" [disabled]="branchList().length === 0" class="primary-btn">
            {{ t().branch.next }}
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/>
            </svg>
          </button>
        </div>
      </div>
    }

    <!-- Step 3: Team -->
    @if (step() === 3) {
      <div class="step-content">
        <div class="step-header">
          <h1>{{ t().team.title }}</h1>
          <p>{{ t().team.subtitle }}</p>
        </div>

        <div class="hint-box">
          {{ language() === 'en' ? 'Optional — you can add team members later from settings.' : 'اختياري — يمكنك إضافة أعضاء الفريق لاحقًا من الإعدادات.' }}
        </div>

        <div class="tabs">
          <button (click)="bulkMode.set(false)" [class.active]="!bulkMode()">{{ t().team.single }}</button>
          <button (click)="bulkMode.set(true)" [class.active]="bulkMode()">{{ t().team.bulk }}</button>
        </div>

        <div class="form-stack">
          @if (!bulkMode()) {
            <div class="field">
              <label>{{ t().team.role }}</label>
              <div class="radio-row">
                <label class="radio" [class.selected]="newMemberRole === 'branch_admin'">
                  <input type="radio" name="role" [(ngModel)]="newMemberRole" value="branch_admin">
                  <span class="radio-check"></span>
                  {{ t().team.roles.branch_admin }}
                </label>
                <label class="radio" [class.selected]="newMemberRole === 'section_admin'">
                  <input type="radio" name="role" [(ngModel)]="newMemberRole" value="section_admin">
                  <span class="radio-check"></span>
                  {{ t().team.roles.section_admin }}
                </label>
              </div>
            </div>

            <div class="field-row">
              <div class="field">
                <label>{{ t().team.name }}</label>
                <input type="text" [(ngModel)]="newMemberName" [placeholder]="t().team.namePH">
              </div>
              <div class="field">
                <label>{{ t().team.email }}</label>
                <input type="email" [(ngModel)]="newMemberEmail" [placeholder]="t().team.emailPH">
              </div>
            </div>

            <div class="field">
              <label>{{ t().team.branch }}</label>
              <select [(ngModel)]="newMemberBranchIndex">
                @for (b of branchList(); track $index) {
                  <option [value]="$index">{{ b.name }}</option>
                }
              </select>
            </div>

            <button (click)="addTeamMember()" [disabled]="!newMemberName || !newMemberEmail" class="secondary-btn">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="8.5" cy="7" r="4"/>
                <line x1="20" y1="8" x2="20" y2="14"/>
                <line x1="23" y1="11" x2="17" y2="11"/>
              </svg>
              {{ t().team.add }}
            </button>
          } @else {
            <div class="dropzone">
              <input type="file" (change)="handleFile($event)" accept=".xlsx, .xls, .csv">
              <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
              </svg>
              <span>{{ t().team.bulkPH }}</span>
              <span class="hint">{{ t().team.bulkColumns }}</span>
            </div>
            <button (click)="downloadSample()" class="link-btn">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              {{ t().team.downloadSample }}
            </button>
          }

          <!-- Team List with Large List Optimization -->
          @if (teamMembers().length > 0) {
            <div class="list-section">
              <div class="list-header">
                <span><strong>{{ teamMembers().length }}</strong> {{ teamMembers().length === 1 ? 'member' : 'members' }} added</span>
                @if (hasManyTeamMembers()) {
                  <button class="list-toggle" (click)="showTeamList.set(!showTeamList())">
                    {{ showTeamList() ? 'Hide list' : 'Show list' }}
                  </button>
                }
              </div>
              
              @if (showTeamList()) {
                <div class="item-list" [class.large]="hasManyTeamMembers()">
                  @for (member of teamDisplayList(); track $index) {
                    <div class="item">
                      <span class="item-avatar">{{ member.name.charAt(0) }}</span>
                      <div class="item-content">
                        <span class="item-name">{{ member.name }}</span>
                        <span class="item-meta">{{ member.email }} · {{ getBranchNameLocal(member.branchIndex) }}</span>
                      </div>
                      <button (click)="removeTeamMember($index)" class="remove-btn">×</button>
                    </div>
                  }
                  @if (teamMembers().length > 5 && showTeamList()) {
                    <div class="list-more">
                      +{{ teamMembers().length - 5 }} more members
                    </div>
                  }
                </div>
              } @else {
                <div class="list-summary">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                  </svg>
                  <strong>{{ teamMembers().length }}</strong> team members ready
                </div>
              }
            </div>
          } @else {
            <div class="empty">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
              </svg>
              {{ t().team.listEmpty }}
            </div>
          }
        </div>

        <div class="step-footer">
          <button (click)="step.set(2)" class="back-btn">← {{ t().branch.back }}</button>
          <div class="footer-actions">
            <button (click)="handleSkip()" class="skip-btn">{{ t().team.skip }}</button>
            <button (click)="startProvisioning()" class="primary-btn">
              {{ t().team.finish }}
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Step 4: Provisioning -->
    @if (step() === 4) {
      <div class="step-content center">
        @if (provisioningError()) {
          <!-- Error State -->
          <div class="error-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="15" y1="9" x2="9" y2="15"/>
              <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
          </div>
          <h1 class="error-title">{{ provisioningError() }}</h1>
          <p class="muted">{{ language() === 'en' ? 'Something went wrong during setup' : 'حدث خطأ أثناء الإعداد' }}</p>
          
          @if (errorDetails()) {
            <div class="error-details">{{ errorDetails() }}</div>
          }
          
          <div class="error-actions">
            <button (click)="retryProvisioning()" class="retry-btn" [disabled]="isRetrying()">
              @if (isRetrying()) {
                <span class="spinner" style="width: 16px; height: 16px; border-width: 2px; margin: 0;"></span>
                {{ language() === 'en' ? 'Retrying...' : 'جارٍ المحاولة...' }}
              } @else {
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="23 4 23 10 17 10"/>
                  <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                </svg>
                {{ language() === 'en' ? 'Try Again' : 'حاول مجددًا' }}
              }
            </button>
          </div>
          <button (click)="goBackFromError()" class="back-link">
            {{ language() === 'en' ? '← Go back and edit' : '← العودة والتعديل' }}
          </button>
        } @else if (!provisioningComplete()) {
          <!-- Progress State -->
          <div class="spinner"></div>
          <h1>{{ t().prov.title }}</h1>
          <p class="muted">{{ language() === 'en' ? 'Setting up your workspace...' : 'جارٍ إعداد مساحة العمل الخاصة بك...' }}</p>
          
          <div class="checklist">
            @for (item of [{s: 1, l: t().prov.step1}, {s: 2, l: t().prov.step2.replace('{0}', '' + branchList().length)}, {s: 3, l: t().prov.step3.replace('{0}', '' + teamMembers().length)}, {s: 4, l: t().prov.step4}]; track item.s) {
              <div class="check-item" [class.done]="provisionStep() > item.s" [class.current]="provisionStep() === item.s">
                <span class="check-icon">
                  @if (provisionStep() > item.s) { ✓ } @else if (provisionStep() === item.s) { ○ }
                </span>
                {{ item.l }}
              </div>
            }
          </div>
          
          @if (branchList().length > 100) {
            <p class="progress-info">
              {{ language() === 'en' ? 'Processing ' + branchList().length + ' branches may take a moment...' : 'قد تستغرق معالجة ' + branchList().length + ' فرع بعض الوقت...' }}
            </p>
          }
        } @else {
          <!-- Success State -->
          <div class="success-icon">✓</div>
          <h1>{{ t().prov.doneTitle }}</h1>
          <p>{{ t().prov.doneDesc }}</p>
          <button (click)="finish()" class="primary-btn large">
            {{ t().prov.button }}
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/>
            </svg>
          </button>
        }
      </div>
    }
  </main>

  <!-- Skip Modal -->
  @if (showSkipConfirmation()) {
    <div class="modal-backdrop" (click)="cancelSkip()">
      <div class="modal" (click)="$event.stopPropagation()">
        <h3>{{ t().team.skipWarningTitle }}</h3>
        <p>{{ t().team.skipWarningText }}</p>
        <div class="modal-actions">
          <button (click)="cancelSkip()" class="modal-btn">{{ t().team.noStay }}</button>
          <button (click)="confirmSkip()" class="modal-btn danger">{{ t().team.yesProceed }}</button>
        </div>
      </div>
    </div>
  }
</div>
