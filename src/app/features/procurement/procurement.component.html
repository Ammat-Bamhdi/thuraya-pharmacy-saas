<!-- 
  Procurement Component - Main Template
  Composes modular template files for procurement management
-->
<div class="h-full flex flex-col animate-fade-in relative" (click)="closeActionMenu(); showBranchMenu.set(false)">
  
  <!-- Header with Branch Switcher -->
  <ng-container *ngTemplateOutlet="procurementHeader"></ng-container>

  <!-- Tab Content -->
  @switch (currentView()) {
    @case ('procurement-orders') {
      <!-- Orders View Inline -->
      @if (store.suppliers().length === 0) {
        <!-- Empty State - Need suppliers first -->
        <div class="glass-panel rounded-xl flex-1 flex items-center justify-center p-12" aria-label="Add suppliers first">
          <div class="text-center max-w-md">
            <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-amber-50 flex items-center justify-center">
              <app-icon name="truck" [size]="40" class="text-amber-500"></app-icon>
            </div>
            <h2 class="text-xl font-semibold text-slate-800 mb-2">Add Suppliers First</h2>
            <p class="text-slate-500 mb-6 leading-relaxed">
              Before creating purchase orders, you need to add at least one supplier to your system.
            </p>
            <button 
              (click)="store.setView('procurement-suppliers')"
              class="inline-flex items-center gap-2 px-6 py-3 bg-teal-600 text-white rounded-xl font-medium hover:bg-teal-700 transition-colors shadow-lg shadow-teal-500/20 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2"
            >
              <app-icon name="plus" [size]="18"></app-icon>
              Add Suppliers
            </button>
          </div>
        </div>
      } @else if (store.purchaseOrders().length === 0) {
        <!-- Empty State - No orders yet -->
        <div class="glass-panel rounded-xl flex-1 flex items-center justify-center p-12" aria-label="Create first order">
          <div class="text-center max-w-md">
            <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center shadow-xl shadow-blue-500/20">
              <app-icon name="file-text" [size]="40" class="text-white"></app-icon>
            </div>
            <h2 class="text-2xl font-semibold text-slate-800 mb-2">Create Your First Order</h2>
            <p class="text-slate-500 mb-6 leading-relaxed">
              Purchase orders help you track what you're buying from suppliers. Create an order to start managing your procurement.
            </p>
            <button 
              (click)="openPOModal()"
              class="inline-flex items-center gap-2 px-6 py-3 bg-teal-600 text-white rounded-xl font-medium hover:bg-teal-700 transition-colors shadow-lg shadow-teal-500/20 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2"
            >
              <app-icon name="plus" [size]="18"></app-icon>
              Create First Order
            </button>
          </div>
        </div>
      } @else {
      <div class="glass-panel rounded-xl flex-1 flex flex-col overflow-hidden animate-fade-in">
        <div class="p-4 border-b border-slate-100 flex flex-col xl:flex-row xl:items-center justify-between gap-4 bg-white/50">
           <div class="flex flex-wrap items-center gap-3 w-full xl:w-auto">
             <div class="relative group w-full sm:w-64 transition-all duration-300 focus-within:w-72">
                <app-icon name="search" [size]="16" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-teal-500 transition-colors pointer-events-none"></app-icon>
                <input type="text" [(ngModel)]="poSearchText" placeholder="Search Order ID..." class="glass-input w-full pl-10 pr-9 py-2 rounded-lg text-xs bg-white transition-all">
                @if (poSearchText()) {
                  <button (click)="poSearchText.set('')" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors p-1 rounded-full hover:bg-slate-100">
                    <app-icon name="x" [size]="12"></app-icon>
                  </button>
                }
             </div>
             <div class="relative">
               <select [(ngModel)]="poStatusFilter" class="glass-input pl-3 pr-8 py-2 rounded-lg text-xs bg-white appearance-none cursor-pointer hover:bg-slate-50 transition-colors min-w-[120px]">
                 <option value="All">All Status</option>
                 <option value="Draft">Draft</option>
                 <option value="Sent">Sent (Pending Bill)</option>
                 <option value="Closed">Closed (Billed)</option>
                 <option value="Cancelled">Cancelled</option>
               </select>
               <app-icon name="chevron-down" [size]="12" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></app-icon>
             </div>
           </div>
           <div class="flex items-center gap-3">
             <button (click)="openPOModal()" class="px-4 py-2 bg-slate-800 text-white text-xs rounded-lg hover:bg-slate-700 shadow-lg shadow-slate-800/20 flex items-center gap-2 transition-all font-medium">
               <app-icon name="plus" [size]="14"></app-icon> New Order
             </button>
           </div>
        </div>

        <div class="overflow-auto flex-1">
           <table class="w-full text-left border-collapse">
             <thead class="sticky top-0 bg-white/95 backdrop-blur z-10 text-xs uppercase text-slate-400 font-medium shadow-sm">
               <tr>
                 <th class="p-3">Order #</th>
                 <th class="p-3">Supplier</th>
                 <th class="p-3">Destination</th>
                 <th class="p-3">Date Created</th>
                 <th class="p-3">Assigned To</th>
                 <th class="p-3 text-center">Status</th>
                 <th class="p-3 text-right">Total</th>
                 <th class="p-3 text-right w-16">Action</th>
               </tr>
             </thead>
             <tbody class="text-sm divide-y divide-slate-50">
               @if (filteredPOs().length === 0) {
                  <tr><td colspan="8" class="p-12 text-center text-slate-400">No orders match your search criteria.</td></tr>
               }
               @for (po of filteredPOs(); track po.id) {
                 <tr class="hover:bg-slate-50 transition-colors group">
                   <td class="p-3 font-mono text-xs font-medium text-slate-700">{{ po.id }}</td>
                   <td class="p-3 font-medium text-slate-700">{{ getSupplierName(po.supplierId) }}</td>
                   <td class="p-3 text-xs text-slate-600 font-semibold">{{ getBranchName(po.branchId) }}</td>
                   <td class="p-3 text-xs text-slate-600">{{ po.date }}</td>
                   <td class="p-3 text-xs text-slate-600">{{ getUserName(po.assignedTo) }}</td>
                   <td class="p-3 text-center">
                      <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold"
                        [class.bg-slate-100]="po.status === 'Draft'" [class.text-slate-600]="po.status === 'Draft'"
                        [class.bg-blue-50]="po.status === 'Sent'" [class.text-blue-600]="po.status === 'Sent'"
                        [class.bg-emerald-50]="po.status === 'Closed'" [class.text-emerald-600]="po.status === 'Closed'"
                        [class.bg-red-50]="po.status === 'Cancelled'" [class.text-red-600]="po.status === 'Cancelled'">
                        {{ po.status }}
                      </span>
                   </td>
                   <td class="p-3 text-right font-medium text-slate-700">{{ po.grandTotal | number }} <span class="text-[10px] text-slate-400 font-normal">YER</span></td>
                   <td class="p-3 text-right">
                     <button (click)="openActionMenu($event, po.id)" class="p-1.5 hover:bg-white rounded-lg text-slate-400 hover:text-teal-600 transition-colors border border-transparent hover:border-slate-100 shadow-sm">
                       <app-icon name="more-horizontal" [size]="16"></app-icon>
                     </button>
                   </td>
                 </tr>
               }
             </tbody>
           </table>
        </div>
      </div>
      }
    }
    @case ('procurement-bills') {
      <!-- Bills View Inline -->
      <div class="glass-panel rounded-xl flex-1 flex flex-col overflow-hidden animate-fade-in">
         <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white/50">
            <div class="flex gap-3 items-center">
               <div class="relative group w-full sm:w-64">
                  <app-icon name="search" [size]="16" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></app-icon>
                  <input type="text" [(ngModel)]="billSearchText" placeholder="Search bills..." class="glass-input w-full pl-10 pr-9 py-2 rounded-lg text-xs bg-white">
               </div>
               <select [(ngModel)]="billStatusFilter" class="glass-input px-3 py-2 rounded-lg text-xs bg-white cursor-pointer">
                  <option value="All">All Status</option>
                  <option value="Unpaid">Unpaid</option>
                  <option value="Partial">Partial</option>
                  <option value="Paid">Paid</option>
               </select>
            </div>
            <button (click)="openNewBillModal()" class="px-4 py-2 bg-slate-800 text-white text-xs rounded-lg hover:bg-slate-700 shadow-lg shadow-slate-800/20 flex items-center gap-2 font-medium">
               <app-icon name="plus" [size]="14"></app-icon> New Bill
            </button>
         </div>
         
         <div class="overflow-auto flex-1">
            <table class="w-full text-left border-collapse">
               <thead class="sticky top-0 bg-white/95 backdrop-blur z-10 text-xs uppercase text-slate-400 font-medium shadow-sm">
                  <tr>
                     <th class="p-3 font-medium border-b border-slate-100">Bill #</th>
                     <th class="p-3 font-medium border-b border-slate-100">PO #</th>
                     <th class="p-3 font-medium border-b border-slate-100">Supplier</th>
                     <th class="p-3 font-medium border-b border-slate-100">Date</th>
                     <th class="p-3 font-medium border-b border-slate-100 text-center">Attachment</th>
                     <th class="p-3 font-medium border-b border-slate-100 text-right">Amount</th>
                     <th class="p-3 font-medium border-b border-slate-100 text-right">Paid</th>
                     <th class="p-3 font-medium border-b border-slate-100">Status</th>
                     <th class="p-3 font-medium border-b border-slate-100 text-right w-20">Actions</th>
                  </tr>
               </thead>
               <tbody class="text-sm divide-y divide-slate-50">
                  @if (filteredBills().length === 0) {
                     <tr><td colspan="9" class="p-12 text-center text-slate-400">No bills found for {{ getBranchName(selectedBranchId()) }}.</td></tr>
                  }
                  @for (bill of filteredBills(); track bill.id) {
                    <tr class="hover:bg-slate-50 transition-colors group">
                       <td class="p-3"><div class="font-mono text-xs font-bold text-slate-700 bg-slate-100 px-2 py-1 rounded w-fit">{{ bill.billNumber }}</div></td>
                       <td class="p-3"><span class="text-slate-600 text-xs">{{ bill.poId }}</span></td>
                       <td class="p-3"><span class="font-semibold text-slate-700">{{ getSupplierName(bill.supplierId) }}</span></td>
                       <td class="p-3"><span class="text-slate-600">{{ bill.billDate }}</span></td>
                       <td class="p-3 text-center">
                          @if (bill.attachmentUrl) {
                             <button (click)="viewBillAttachment(bill)" class="p-1.5 hover:bg-slate-100 rounded-lg text-teal-600 transition-colors" title="View Invoice">
                                <app-icon name="file-text" [size]="16"></app-icon>
                             </button>
                          } @else {
                             <span class="text-slate-300">-</span>
                          }
                       </td>
                       <td class="p-3 text-right"><span class="font-bold text-slate-700">{{ bill.totalAmount | number }}</span></td>
                       <td class="p-3 text-right">
                          <div class="flex flex-col items-end">
                             <span class="font-bold text-teal-600">{{ bill.paidAmount | number }}</span>
                             <div class="w-20 h-1 bg-slate-100 rounded-full overflow-hidden mt-1">
                                <div class="h-full bg-teal-500 transition-all" [style.width.%]="(bill.paidAmount / bill.totalAmount) * 100"></div>
                             </div>
                          </div>
                       </td>
                       <td class="p-3">
                          <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold"
                            [class.bg-red-50]="bill.status === 'Unpaid'" [class.text-red-600]="bill.status === 'Unpaid'"
                            [class.bg-amber-50]="bill.status === 'Partial'" [class.text-amber-600]="bill.status === 'Partial'"
                            [class.bg-emerald-50]="bill.status === 'Paid'" [class.text-emerald-600]="bill.status === 'Paid'">
                            {{ getBillStatusLabel(bill.status) }}
                          </span>
                       </td>
                       <td class="p-3 text-right">
                          <button (click)="openBillModal(bill)" class="p-1.5 hover:bg-slate-100 rounded-lg text-slate-400 hover:text-teal-600 transition-colors" title="Manage Payments">
                             <app-icon name="dollar-sign" [size]="16"></app-icon>
                          </button>
                       </td>
                    </tr>
                  }
               </tbody>
            </table>
         </div>
      </div>
    }
    @case ('procurement-suppliers') {
      <!-- Suppliers View Inline -->
      @if (store.suppliers().length === 0) {
        <!-- Empty State for Suppliers -->
        <div class="glass-panel rounded-xl flex-1 flex items-center justify-center p-12" aria-label="Add your first supplier">
          <div class="text-center max-w-md">
            <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-teal-400 to-teal-600 flex items-center justify-center shadow-xl shadow-teal-500/20">
              <app-icon name="truck" [size]="40" class="text-white"></app-icon>
            </div>
            <h2 class="text-2xl font-semibold text-slate-800 mb-2">Add Your First Supplier</h2>
            <p class="text-slate-500 mb-6 leading-relaxed">
              Suppliers are the foundation of your procurement workflow. Add your pharmaceutical distributors and vendors to start creating purchase orders.
            </p>
            <button 
              (click)="openSupplierModal()"
              class="inline-flex items-center gap-2 px-6 py-3 bg-teal-600 text-white rounded-xl font-medium hover:bg-teal-700 transition-colors shadow-lg shadow-teal-500/20 focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2"
            >
              <app-icon name="plus" [size]="18"></app-icon>
              Add First Supplier
            </button>
          </div>
        </div>
      } @else {
      <div class="glass-panel rounded-xl flex-1 flex flex-col overflow-hidden animate-fade-in">
        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white/50">
           <div class="relative group w-full sm:w-64">
              <app-icon name="search" [size]="16" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></app-icon>
              <input type="text" [(ngModel)]="searchText" placeholder="Search Suppliers..." class="glass-input w-full pl-10 pr-9 py-2 rounded-lg text-xs bg-white">
           </div>
           <button (click)="openSupplierModal()" class="px-4 py-2 bg-slate-800 text-white text-xs rounded-lg hover:bg-slate-700 shadow-lg shadow-slate-800/20 flex items-center gap-2 font-medium">
              <app-icon name="plus" [size]="14"></app-icon> New Supplier
           </button>
        </div>
        
        <div class="overflow-auto flex-1">
           <table class="w-full text-left border-collapse">
              <thead class="sticky top-0 bg-white/95 backdrop-blur z-10 text-xs uppercase text-slate-400 font-medium shadow-sm">
                 <tr>
                    <th class="p-3">Code</th>
                    <th class="p-3">Name</th>
                    <th class="p-3">Contact Person</th>
                    <th class="p-3 text-center">Status</th>
                    <th class="p-3 text-right">Balance</th>
                    <th class="p-3 w-10"></th>
                 </tr>
              </thead>
              <tbody class="text-sm divide-y divide-slate-50">
                 @if (filteredSuppliers().length === 0) {
                    <tr><td colspan="6" class="p-12 text-center text-slate-400">No suppliers match your search.</td></tr>
                 }
                 @for (s of filteredSuppliers(); track s.id) {
                    <tr class="hover:bg-slate-50 transition-colors">
                       <td class="p-3 font-mono text-xs text-slate-500">{{ s.code }}</td>
                       <td class="p-3 font-medium text-slate-800">{{ s.name }}</td>
                       <td class="p-3 text-slate-600">{{ s.contactPerson }}</td>
                       <td class="p-3 text-center">
                          <span class="px-2 py-0.5 rounded-full text-[10px] font-bold" 
                             [class.bg-emerald-50]="s.status === 'Active'" [class.text-emerald-600]="s.status === 'Active'"
                             [class.bg-slate-100]="s.status !== 'Active'" [class.text-slate-500]="s.status !== 'Active'">{{ s.status }}</span>
                       </td>
                       <td class="p-3 text-right font-medium">{{ s.currentBalance | number }}</td>
                       <td class="p-3 text-right"><button (click)="openActionMenu($event, s.id)" class="p-1 text-slate-400 hover:text-teal-600"><app-icon name="more-horizontal" [size]="16"></app-icon></button></td>
                    </tr>
                 }
              </tbody>
           </table>
        </div>
      </div>
      }
    }
    @default {
      <!-- Default fallback to orders -->
      <div class="p-12 text-center text-slate-400">Loading...</div>
    }
  }

  <!-- Modals -->
  @if (showPOModal()) {
    <ng-container *ngTemplateOutlet="poModal"></ng-container>
  }
  
  @if (showQuickProductModal()) {
    <ng-container *ngTemplateOutlet="quickProductModal"></ng-container>
  }
  
  @if (showSupplierModal()) {
    <ng-container *ngTemplateOutlet="supplierModal"></ng-container>
  }
  
  @if (showReceiveModal()) {
    <ng-container *ngTemplateOutlet="receiveModal"></ng-container>
  }
  
  @if (showDeactivateModal()) {
    <ng-container *ngTemplateOutlet="deactivateModal"></ng-container>
  }
  
  @if (showReceiptModal()) {
    <ng-container *ngTemplateOutlet="receiptViewer"></ng-container>
  }

  <!-- Action Menu Overlay -->
  @if (activeActionRow()) {
    <ng-container *ngTemplateOutlet="actionMenu"></ng-container>
  }
</div>

<!-- ============================================== -->
<!-- TEMPLATE DEFINITIONS -->
<!-- ============================================== -->

<!-- Header Template -->
<ng-template #procurementHeader>
  <header class="flex flex-col gap-6 mb-6 shrink-0">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
       <div>
          <h2 class="text-2xl font-light tracking-tight text-slate-800">Procurement</h2>
          <p class="text-sm text-slate-500 font-light mt-1">
             @if (currentView() === 'procurement-orders') { Purchase Orders }
             @else if (currentView() === 'procurement-bills') { Bills & Payments }
             @else if (currentView() === 'procurement-suppliers') { Supplier Management }
             @else { Management }
          </p>
       </div>

       <!-- Branch Switcher -->
       <div class="relative z-30" (click)="$event.stopPropagation()">
          <button 
            (click)="showBranchMenu.set(!showBranchMenu())"
            class="flex items-center gap-4 pl-2 pr-5 py-2 bg-slate-900 text-white rounded-full shadow-xl shadow-slate-900/20 hover:bg-slate-800 hover:scale-[1.02] transition-all group"
          >
             <div class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-teal-400 border border-white/10">
                <app-icon name="map-pin" [size]="18"></app-icon>
             </div>
             <div class="text-left">
                <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider leading-none mb-1">Active Branch</div>
                <div class="text-sm font-bold text-white leading-none tracking-wide">{{ getBranchName(selectedBranchId()) }}</div>
             </div>
             <div class="pl-2 border-l border-white/10 ml-1">
                <app-icon name="chevron-down" [size]="16" class="text-slate-400 group-hover:text-white transition-colors" [class.rotate-180]="showBranchMenu()"></app-icon>
             </div>
          </button>

          @if (showBranchMenu()) {
             <div class="absolute top-full right-0 mt-3 w-80 bg-white rounded-2xl shadow-2xl border border-slate-100 overflow-hidden animate-fade-in origin-top-right ring-1 ring-black/5">
                <div class="p-4 bg-slate-50/50 border-b border-slate-100 text-xs font-bold text-slate-500 uppercase tracking-wider flex justify-between items-center">
                   <span>Select Location</span>
                   <span class="bg-teal-100 text-teal-700 px-2 py-0.5 rounded text-[10px]">Live</span>
                </div>
                <div class="max-h-72 overflow-y-auto p-2 space-y-1">
                   @for (b of store.branches(); track b.id) {
                      <button 
                         (click)="selectedBranchId.set(b.id); showBranchMenu.set(false)"
                         class="w-full flex items-center gap-4 p-3 rounded-xl transition-all text-left group border border-transparent"
                         [class.bg-teal-50]="selectedBranchId() === b.id"
                         [class.border-teal-100]="selectedBranchId() === b.id"
                         [class.hover:bg-slate-50]="selectedBranchId() !== b.id"
                      >
                         <div class="w-10 h-10 rounded-xl flex items-center justify-center shadow-sm border transition-all"
                            [class.bg-white]="selectedBranchId() === b.id" [class.text-teal-600]="selectedBranchId() === b.id" [class.border-teal-200]="selectedBranchId() === b.id"
                            [class.bg-slate-100]="selectedBranchId() !== b.id" [class.text-slate-400]="selectedBranchId() !== b.id" [class.border-slate-200]="selectedBranchId() !== b.id">
                            <span class="font-black text-sm tracking-tighter">{{ b.code.substring(0,2) }}</span>
                         </div>
                         <div class="flex-1">
                            <div class="text-sm font-bold" [class.text-teal-900]="selectedBranchId() === b.id" [class.text-slate-700]="selectedBranchId() !== b.id">{{ b.name }}</div>
                            <div class="text-[11px]" [class.text-teal-600]="selectedBranchId() === b.id" [class.text-slate-400]="selectedBranchId() !== b.id">{{ b.location }}</div>
                         </div>
                         @if (selectedBranchId() === b.id) {
                            <div class="w-2 h-2 rounded-full bg-teal-500 shadow-[0_0_8px_rgba(20,184,166,0.6)]"></div>
                         }
                      </button>
                   }
                </div>
             </div>
          }
       </div>
    </div>
  </header>
</ng-template>

<!-- Orders View Template -->
<ng-template #ordersView>
  <div class="glass-panel rounded-xl flex-1 flex flex-col overflow-hidden animate-fade-in">
    <div class="p-4 border-b border-slate-100 flex flex-col xl:flex-row xl:items-center justify-between gap-4 bg-white/50">
       <div class="flex flex-wrap items-center gap-3 w-full xl:w-auto">
         <div class="relative group w-full sm:w-64 transition-all duration-300 focus-within:w-72">
            <app-icon name="search" [size]="16" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 group-focus-within:text-teal-500 transition-colors pointer-events-none"></app-icon>
            <input type="text" [(ngModel)]="poSearchText" placeholder="Search Order ID..." class="glass-input w-full pl-10 pr-9 py-2 rounded-lg text-xs bg-white transition-all">
            @if (poSearchText()) {
              <button (click)="poSearchText.set('')" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 transition-colors p-1 rounded-full hover:bg-slate-100">
                <app-icon name="x" [size]="12"></app-icon>
              </button>
            }
         </div>
         <div class="relative">
           <select [(ngModel)]="poStatusFilter" class="glass-input pl-3 pr-8 py-2 rounded-lg text-xs bg-white appearance-none cursor-pointer hover:bg-slate-50 transition-colors min-w-[120px]">
             <option value="All">All Status</option>
             <option value="Draft">Draft</option>
             <option value="Sent">Sent (Pending Bill)</option>
             <option value="Closed">Closed (Billed)</option>
             <option value="Cancelled">Cancelled</option>
           </select>
           <app-icon name="chevron-down" [size]="12" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></app-icon>
         </div>
       </div>
       <div class="flex items-center gap-3">
         <button (click)="openPOModal()" class="px-4 py-2 bg-slate-800 text-white text-xs rounded-lg hover:bg-slate-700 shadow-lg shadow-slate-800/20 flex items-center gap-2 transition-all font-medium">
           <app-icon name="plus" [size]="14"></app-icon> New Order
         </button>
       </div>
    </div>

    <div class="overflow-auto flex-1">
       <table class="w-full text-left border-collapse">
         <thead class="sticky top-0 bg-white/95 backdrop-blur z-10 text-xs uppercase text-slate-400 font-medium shadow-sm">
           <tr>
             <th class="p-3">Order #</th>
             <th class="p-3">Supplier</th>
             <th class="p-3">Destination</th>
             <th class="p-3">Date Created</th>
             <th class="p-3">Assigned To</th>
             <th class="p-3 text-center">Status</th>
             <th class="p-3 text-right">Total</th>
             <th class="p-3 text-right w-16">Action</th>
           </tr>
         </thead>
         <tbody class="text-sm divide-y divide-slate-50">
           @if (filteredPOs().length === 0) {
              <tr><td colspan="8" class="p-12 text-center text-slate-400">No orders found for {{ getBranchName(selectedBranchId()) }}.</td></tr>
           }
           @for (po of filteredPOs(); track po.id) {
             <tr class="hover:bg-slate-50 transition-colors group">
               <td class="p-3 font-mono text-xs font-medium text-slate-700">{{ po.id }}</td>
               <td class="p-3 font-medium text-slate-700">{{ getSupplierName(po.supplierId) }}</td>
               <td class="p-3 text-xs text-slate-600 font-semibold">{{ getBranchName(po.branchId) }}</td>
               <td class="p-3 text-xs text-slate-600">{{ po.date }}</td>
               <td class="p-3 text-xs text-slate-600">{{ getUserName(po.assignedTo) }}</td>
               <td class="p-3 text-center">
                  <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold"
                    [class.bg-slate-100]="po.status === 'Draft'" [class.text-slate-600]="po.status === 'Draft'"
                    [class.bg-blue-50]="po.status === 'Sent'" [class.text-blue-600]="po.status === 'Sent'"
                    [class.bg-emerald-50]="po.status === 'Closed'" [class.text-emerald-600]="po.status === 'Closed'"
                    [class.bg-red-50]="po.status === 'Cancelled'" [class.text-red-600]="po.status === 'Cancelled'">
                    {{ po.status }}
                  </span>
               </td>
               <td class="p-3 text-right font-medium text-slate-700">{{ po.grandTotal | number }} <span class="text-[10px] text-slate-400 font-normal">YER</span></td>
               <td class="p-3 text-right">
                 <button (click)="openActionMenu($event, po.id)" class="p-1.5 hover:bg-white rounded-lg text-slate-400 hover:text-teal-600 transition-colors border border-transparent hover:border-slate-100 shadow-sm">
                   <app-icon name="more-horizontal" [size]="16"></app-icon>
                 </button>
               </td>
             </tr>
           }
         </tbody>
       </table>
    </div>
  </div>
</ng-template>

<!-- Bills View Template -->
<ng-template #billsView>
  <div class="glass-panel rounded-xl flex-1 flex flex-col overflow-hidden animate-fade-in">
     <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white/50">
        <div class="flex gap-3 items-center">
           <div class="relative group w-full sm:w-64">
              <app-icon name="search" [size]="16" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></app-icon>
              <input type="text" [(ngModel)]="billSearchText" placeholder="Search bills..." class="glass-input w-full pl-10 pr-9 py-2 rounded-lg text-xs bg-white">
           </div>
           <select [(ngModel)]="billStatusFilter" class="glass-input px-3 py-2 rounded-lg text-xs bg-white cursor-pointer">
              <option value="All">All Status</option>
              <option value="Unpaid">Unpaid</option>
              <option value="Partial">Partial</option>
              <option value="Paid">Paid</option>
           </select>
        </div>
        <button (click)="openNewBillModal()" class="px-4 py-2 bg-slate-800 text-white text-xs rounded-lg hover:bg-slate-700 shadow-lg shadow-slate-800/20 flex items-center gap-2 font-medium">
           <app-icon name="plus" [size]="14"></app-icon> New Bill
        </button>
     </div>
     
     <div class="overflow-auto flex-1">
        <table class="w-full text-left border-collapse">
           <thead class="sticky top-0 bg-white/95 backdrop-blur z-10 text-xs uppercase text-slate-400 font-medium shadow-sm">
              <tr>
                 <th class="p-3 font-medium border-b border-slate-100">Bill #</th>
                 <th class="p-3 font-medium border-b border-slate-100">PO #</th>
                 <th class="p-3 font-medium border-b border-slate-100">Supplier</th>
                 <th class="p-3 font-medium border-b border-slate-100">Date</th>
                 <th class="p-3 font-medium border-b border-slate-100 text-center">Attachment</th>
                 <th class="p-3 font-medium border-b border-slate-100 text-right">Amount</th>
                 <th class="p-3 font-medium border-b border-slate-100 text-right">Paid</th>
                 <th class="p-3 font-medium border-b border-slate-100">Status</th>
                 <th class="p-3 font-medium border-b border-slate-100 text-right w-20">Actions</th>
              </tr>
           </thead>
           <tbody class="text-sm divide-y divide-slate-50">
              @if (filteredBills().length === 0) {
                 <tr><td colspan="9" class="p-12 text-center text-slate-400">No bills found for {{ getBranchName(selectedBranchId()) }}.</td></tr>
              }
              @for (bill of filteredBills(); track bill.id) {
                <tr class="hover:bg-slate-50 transition-colors group">
                   <td class="p-3"><div class="font-mono text-xs font-bold text-slate-700 bg-slate-100 px-2 py-1 rounded w-fit">{{ bill.billNumber }}</div></td>
                   <td class="p-3"><span class="text-slate-600 text-xs">{{ bill.poId }}</span></td>
                   <td class="p-3"><span class="font-semibold text-slate-700">{{ getSupplierName(bill.supplierId) }}</span></td>
                   <td class="p-3"><span class="text-slate-600">{{ bill.billDate }}</span></td>
                   <td class="p-3 text-center">
                      @if (bill.attachmentUrl) {
                         <button (click)="viewBillAttachment(bill)" class="p-1.5 hover:bg-slate-100 rounded-lg text-teal-600 transition-colors" title="View Invoice">
                            <app-icon name="file-text" [size]="16"></app-icon>
                         </button>
                      } @else {
                         <span class="text-slate-300">-</span>
                      }
                   </td>
                   <td class="p-3 text-right"><span class="font-bold text-slate-700">{{ bill.totalAmount | number }}</span></td>
                   <td class="p-3 text-right">
                      <div class="flex flex-col items-end">
                         <span class="font-bold text-teal-600">{{ bill.paidAmount | number }}</span>
                         <div class="w-20 h-1 bg-slate-100 rounded-full overflow-hidden mt-1">
                            <div class="h-full bg-teal-500 transition-all" [style.width.%]="(bill.paidAmount / bill.totalAmount) * 100"></div>
                         </div>
                      </div>
                   </td>
                   <td class="p-3">
                      <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-[10px] font-bold"
                        [class.bg-red-50]="bill.status === 'Unpaid'" [class.text-red-600]="bill.status === 'Unpaid'"
                        [class.bg-amber-50]="bill.status === 'Partial'" [class.text-amber-600]="bill.status === 'Partial'"
                        [class.bg-emerald-50]="bill.status === 'Paid'" [class.text-emerald-600]="bill.status === 'Paid'">
                        {{ getBillStatusLabel(bill.status) }}
                      </span>
                   </td>
                   <td class="p-3 text-right">
                      <button (click)="openBillModal(bill)" class="p-1.5 hover:bg-slate-100 rounded-lg text-slate-400 hover:text-teal-600 transition-colors" title="Manage Payments">
                         <app-icon name="dollar-sign" [size]="16"></app-icon>
                      </button>
                   </td>
                </tr>
              }
           </tbody>
        </table>
     </div>
  </div>
</ng-template>

<!-- Suppliers View Template -->
<ng-template #suppliersView>
  <div class="glass-panel rounded-xl flex-1 flex flex-col overflow-hidden animate-fade-in">
    <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-white/50">
       <div class="relative group w-full sm:w-64">
          <app-icon name="search" [size]="16" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></app-icon>
          <input type="text" [(ngModel)]="searchText" placeholder="Search Suppliers..." class="glass-input w-full pl-10 pr-9 py-2 rounded-lg text-xs bg-white">
       </div>
       <button (click)="openSupplierModal()" class="px-4 py-2 bg-slate-800 text-white text-xs rounded-lg hover:bg-slate-700 shadow-lg shadow-slate-800/20 flex items-center gap-2 font-medium">
          <app-icon name="plus" [size]="14"></app-icon> New Supplier
       </button>
    </div>
    
    <div class="overflow-auto flex-1">
       <table class="w-full text-left border-collapse">
          <thead class="sticky top-0 bg-white/95 backdrop-blur z-10 text-xs uppercase text-slate-400 font-medium shadow-sm">
             <tr>
                <th class="p-3">Code</th>
                <th class="p-3">Name</th>
                <th class="p-3">Contact Person</th>
                <th class="p-3 text-center">Status</th>
                <th class="p-3 text-right">Balance</th>
                <th class="p-3 w-10"></th>
             </tr>
          </thead>
          <tbody class="text-sm divide-y divide-slate-50">
             @for (s of filteredSuppliers(); track s.id) {
                <tr class="hover:bg-slate-50 transition-colors">
                   <td class="p-3 font-mono text-xs text-slate-500">{{ s.code }}</td>
                   <td class="p-3 font-medium text-slate-800">{{ s.name }}</td>
                   <td class="p-3 text-slate-600">{{ s.contactPerson }}</td>
                   <td class="p-3 text-center">
                      <span class="px-2 py-0.5 rounded-full text-[10px] font-bold" 
                         [class.bg-emerald-50]="s.status === 'Active'" [class.text-emerald-600]="s.status === 'Active'"
                         [class.bg-slate-100]="s.status !== 'Active'" [class.text-slate-500]="s.status !== 'Active'">{{ s.status }}</span>
                   </td>
                   <td class="p-3 text-right font-medium">{{ s.currentBalance | number }}</td>
                   <td class="p-3 text-right"><button (click)="openActionMenu($event, s.id)" class="p-1 text-slate-400 hover:text-teal-600"><app-icon name="more-horizontal" [size]="16"></app-icon></button></td>
                </tr>
             }
          </tbody>
       </table>
    </div>
  </div>
</ng-template>

<!-- PO Modal Template -->
<ng-template #poModal>
  <div class="absolute inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm animate-fade-in p-4" (click)="closePOModal()" role="dialog" aria-modal="true">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-[95vw] h-[90vh] flex flex-col border border-slate-200 overflow-hidden" (click)="$event.stopPropagation()">
       
       <!-- Clean Toolbar Header -->
       <div class="px-6 py-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center shrink-0">
          <div class="flex items-center gap-4">
             <div class="p-2.5 bg-white rounded-xl border border-slate-200 shadow-sm text-teal-600">
                <app-icon name="file-text" [size]="24"></app-icon>
             </div>
             <div>
                <h3 class="text-lg font-bold text-slate-800 tracking-tight">{{ editingPOId() ? 'Edit Order ' + editingPOId() : 'Create Purchase Order' }}</h3>
                <p class="text-xs text-slate-500 font-medium">Procurement Workspace</p>
             </div>
          </div>
          
          <div class="flex items-center gap-4">
             <form [formGroup]="poForm" class="flex items-center gap-4">
                <div class="flex flex-col">
                   <label class="text-[10px] font-bold text-slate-500 uppercase mb-1">Supplier</label>
                   <select formControlName="supplierId" (change)="onSupplierChange()" [attr.disabled]="editingPOId() ? true : null" class="h-9 py-0 pl-3 pr-8 rounded-lg text-sm font-medium text-slate-700 bg-white border border-slate-300 focus:border-teal-500 focus:ring-1 focus:ring-teal-500 min-w-[220px]">
                      <option value="" disabled>-- Select Supplier --</option>
                      @for(s of store.suppliers(); track s.id) { <option [value]="s.id">{{ s.name }}</option> }
                   </select>
                </div>
                <div class="flex flex-col">
                   <label class="text-[10px] font-bold text-slate-500 uppercase mb-1">Destination</label>
                   <select formControlName="branchId" (change)="onBranchChange()" [attr.disabled]="editingPOId() ? true : null" class="h-9 py-0 pl-3 pr-8 rounded-lg text-sm font-medium text-slate-700 bg-white border border-slate-300 focus:border-teal-500 focus:ring-1 focus:ring-teal-500 min-w-[200px]">
                      <option value="" disabled>-- Select Branch --</option>
                      @for(b of store.branches(); track b.id) { <option [value]="b.id">{{ b.name }}</option> }
                   </select>
                </div>
                <div class="flex flex-col">
                   <label class="text-[10px] font-bold text-slate-500 uppercase mb-1">Order Date</label>
                   <input type="date" formControlName="date" class="h-9 py-0 px-3 rounded-lg text-sm font-medium text-slate-700 bg-white border border-slate-300 focus:border-teal-500 focus:ring-1 focus:ring-teal-500">
                </div>
             </form>
             <div class="h-8 w-px bg-slate-200 mx-2"></div>
             <button (click)="closePOModal()" class="text-slate-400 hover:text-slate-600 transition-colors p-2 hover:bg-slate-100 rounded-full" title="Close">
                <app-icon name="x" [size]="20"></app-icon>
             </button>
          </div>
       </div>

       <!-- Main Workspace -->
       <div class="flex-1 flex flex-col overflow-hidden bg-white relative">
          <div class="flex-1 overflow-auto" [class.opacity-50]="!poForm.get('branchId')?.value || !poForm.get('supplierId')?.value" [class.pointer-events-none]="!poForm.get('branchId')?.value || !poForm.get('supplierId')?.value">
             <table class="w-full text-left border-collapse">
                <thead class="sticky top-0 z-20 bg-white shadow-sm ring-1 ring-slate-200">
                   <tr class="text-[10px] uppercase text-slate-500 font-bold bg-slate-50 border-b border-slate-200">
                      <th scope="col" class="py-3 px-4 w-[35%]">Product Description</th>
                      <th scope="col" class="py-3 px-4 w-[12%]">Category</th>
                      <th scope="col" class="py-3 px-4 w-[15%]">Expiry Date</th>
                      <th scope="col" class="py-3 px-4 w-[10%] text-center">Qty</th>
                      <th scope="col" class="py-3 px-4 w-[12%] text-right">Unit Cost</th>
                      <th scope="col" class="py-3 px-4 w-[10%] text-right">Total</th>
                      <th scope="col" class="py-3 px-4 w-12 text-center"></th>
                   </tr>
                   
                   <!-- Rapid Entry Row -->
                   @if (!editingPOId()) {
                      <tr class="bg-teal-50/20 border-b-2 border-teal-500/20 relative transition-colors focus-within:bg-teal-50/40">
                         <td class="p-3">
                            <div class="flex rounded-lg shadow-sm border border-slate-300 bg-white focus-within:ring-2 focus-within:ring-teal-500 focus-within:border-teal-500 overflow-visible relative">
                               <div class="relative flex-1">
                                  <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                     <app-icon name="search" [size]="16" class="text-slate-400"></app-icon>
                                  </div>
                                  <input 
                                     #searchInput
                                     type="text" 
                                     [ngModel]="searchQueryInternal()" 
                                     [ngModelOptions]="{standalone:true}" 
                                     (ngModelChange)="onSearchInput($event)" 
                                     (blur)="hideProductDropdownDelayed()" 
                                     (focus)="onSearchFocus()"
                                     placeholder="Search Name or SKU..." 
                                     class="w-full pl-9 pr-2 py-2.5 bg-transparent border-none outline-none text-sm font-medium text-slate-900 placeholder:text-slate-400 transition-all"
                                     aria-label="Product Search"
                                  >
                               </div>

                               <div class="border-l border-slate-200 bg-slate-50 hover:bg-slate-100 transition-colors relative">
                                  <select [(ngModel)]="searchCategory" [ngModelOptions]="{standalone:true}" class="h-full pl-3 pr-8 text-xs font-bold text-slate-600 bg-transparent border-none focus:ring-0 cursor-pointer appearance-none outline-none" title="Filter by Category">
                                     <option value="All">All Categories</option>
                                     <option value="Pharmaceuticals">Pharma</option>
                                     <option value="Equipment">Equip</option>
                                     <option value="Supplies">Supply</option>
                                  </select>
                                  <app-icon name="chevron-down" [size]="10" class="absolute right-2 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none"></app-icon>
                               </div>

                               @if (showProductDropdown()) {
                                  <div class="absolute top-full left-0 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-xl max-h-80 overflow-y-auto z-50 animate-fade-in ring-1 ring-black/5">
                                     @if (optimizedProductOptions().length > 0) {
                                        @for (p of optimizedProductOptions(); track p.id || p.name) {
                                           <button type="button" (click)="selectProduct(p, costInput, qtyInput, expiryInput)" class="w-full text-left px-4 py-3 hover:bg-teal-50 text-sm border-b border-slate-50 last:border-0 flex justify-between items-center group transition-colors">
                                              <div>
                                                 <div class="font-bold text-slate-800 group-hover:text-teal-700 flex items-center gap-2">
                                                    {{ p.name }}
                                                    @if (!p.existsInTarget) {
                                                       <span class="text-[9px] bg-blue-50 text-blue-700 px-1.5 py-0.5 rounded border border-blue-100 font-bold tracking-wide uppercase">New</span>
                                                    }
                                                 </div>
                                                 <div class="text-xs text-slate-400 font-mono mt-0.5 flex gap-2">
                                                    <span>{{ p.sku }}</span> <span class="text-slate-300">â€¢</span> <span>{{ p.category }}</span>
                                                 </div>
                                              </div>
                                              <div class="text-right">
                                                 @if (p.existsInTarget) {
                                                    <div class="font-bold text-slate-700">{{ p.cost | number }} <span class="text-[10px] text-slate-400 font-normal">YER</span></div>
                                                    <div class="text-[10px] text-slate-500 bg-slate-100 px-2 py-0.5 rounded-full inline-block mt-1">Stock: {{ p.targetStock }}</div>
                                                 } @else {
                                                    <div class="text-teal-600 font-bold flex items-center gap-1 justify-end text-xs">
                                                       <app-icon name="download" [size]="12"></app-icon> Create
                                                    </div>
                                                 }
                                              </div>
                                           </button>
                                        }
                                     } @else {
                                        <div class="p-6 text-center">
                                           <p class="text-sm text-slate-500 mb-3">No matches for "{{ searchQueryInternal() }}"</p>
                                           <button (click)="openQuickProductModal()" class="text-xs bg-slate-800 text-white px-4 py-2 rounded-lg hover:bg-slate-700 font-bold shadow-md transition-all flex items-center gap-2 mx-auto">
                                              <app-icon name="plus" [size]="14"></app-icon> Create New Product
                                           </button>
                                        </div>
                                     }
                                  </div>
                               }
                            </div>
                         </td>
                         <td class="p-3 text-xs font-medium text-slate-500 italic">
                            {{ selectedProduct()?.category || '-' }}
                         </td>
                         <td class="p-3">
                            <input #expiryInput type="date" class="w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-sm focus:border-teal-500 focus:ring-1 focus:ring-teal-500 outline-none text-slate-700 font-medium shadow-sm transition-all" aria-label="Expiry Date">
                         </td>
                         <td class="p-3">
                            <input #qtyInput type="number" min="1" value="1" class="w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-sm text-center font-bold text-slate-800 focus:border-teal-500 focus:ring-1 focus:ring-teal-500 outline-none shadow-sm transition-all" aria-label="Quantity">
                         </td>
                         <td class="p-3">
                            <input #costInput type="number" min="0" class="w-full bg-white border border-slate-300 rounded-lg py-2 px-3 text-sm text-right font-bold text-slate-800 focus:border-teal-500 focus:ring-1 focus:ring-teal-500 outline-none shadow-sm transition-all" aria-label="Unit Cost">
                         </td>
                         <td class="p-3 text-right font-bold text-teal-700 text-sm">
                            {{ (qtyInput.valueAsNumber || 0) * (costInput.valueAsNumber || 0) | number }}
                         </td>
                         <td class="p-3 text-center">
                            <button (click)="addItemToPO(qtyInput, costInput, expiryInput)" [disabled]="!selectedProduct()" class="w-9 h-9 bg-teal-600 hover:bg-teal-700 text-white rounded-lg flex items-center justify-center shadow-md hover:shadow-lg transition-all disabled:opacity-50 disabled:shadow-none disabled:bg-slate-300" title="Add Item">
                               <app-icon name="plus" [size]="20"></app-icon>
                            </button>
                         </td>
                      </tr>
                   }
                </thead>
                
                <tbody class="divide-y divide-slate-100 text-sm">
                   @if (poItems().length === 0) { 
                      <tr class="h-96">
                         <td colspan="7" class="align-middle text-center">
                            <div class="flex flex-col items-center justify-center gap-4 opacity-80">
                               <div class="p-4 bg-slate-50 rounded-full border border-slate-100 shadow-sm">
                                  <app-icon name="package" [size]="40" class="text-slate-400"></app-icon>
                               </div>
                               <div class="flex flex-col gap-1">
                                  <span class="text-slate-600 font-semibold text-sm">No items added yet</span>
                                  <span class="text-slate-500 text-xs">Start building your order using the input row above.</span>
                               </div>
                            </div>
                         </td>
                      </tr> 
                   }
                   @for (item of poItems(); track $index) {
                      <tr class="hover:bg-slate-50 transition-colors group">
                         <td class="p-4 pl-4">
                            <div class="flex flex-col">
                               <span class="font-bold text-slate-800">{{ item.productName }}</span>
                               @if (item.isNetworkImport) {
                                  <span class="inline-flex items-center gap-1 text-[10px] text-blue-700 bg-blue-50 border border-blue-100 rounded px-1.5 py-0.5 w-fit mt-1 font-medium">
                                     New Catalog Entry
                                  </span>
                               }
                            </div>
                         </td>
                         <td class="p-4">
                            <span class="text-xs font-medium text-slate-600 bg-slate-100 px-2 py-1 rounded">{{ item.productDetails?.category || 'General' }}</span>
                         </td>
                         <td class="p-4">
                            @if (!editingPOId()) { 
                               <input type="date" [ngModel]="item.expiryDate" [ngModelOptions]="{standalone: true}" (ngModelChange)="updateItem($index, 'expiryDate', $event)" class="bg-transparent border-b border-transparent hover:border-slate-300 focus:border-teal-500 outline-none text-slate-600 text-sm w-32 transition-colors font-medium">
                            } @else { 
                               <span class="text-slate-600 font-medium">{{ item.expiryDate || '-' }}</span> 
                            }
                         </td>
                         <td class="p-4 text-center">
                            @if (!editingPOId()) { 
                               <input type="number" [ngModel]="item.quantity" [ngModelOptions]="{standalone: true}" (ngModelChange)="updateItem($index, 'quantity', $event)" min="1" class="w-16 text-center bg-transparent border-b border-transparent hover:border-slate-300 focus:border-teal-500 outline-none font-bold text-slate-800 transition-colors"> 
                            } @else { 
                               <span class="font-bold text-slate-800">{{ item.quantity }}</span> 
                            }
                         </td>
                         <td class="p-4 text-right">
                            @if (!editingPOId()) { 
                               <input type="number" [ngModel]="item.unitCost" [ngModelOptions]="{standalone: true}" (ngModelChange)="updateItem($index, 'unitCost', $event)" min="0" class="w-24 text-right bg-transparent border-b border-transparent hover:border-slate-300 focus:border-teal-500 outline-none font-medium text-slate-700 transition-colors"> 
                            } @else { 
                               <span class="font-medium text-slate-700">{{ item.unitCost | number }}</span> 
                            }
                         </td>
                         <td class="p-4 text-right font-bold text-slate-900">{{ item.quantity * item.unitCost | number }}</td>
                         <td class="p-4 text-center">
                            @if (!editingPOId()) { 
                               <button (click)="removeItemFromPO($index)" class="p-2 text-slate-400 hover:text-red-500 rounded-lg hover:bg-red-50 transition-colors" title="Remove Item"><app-icon name="trash-2" [size]="16"></app-icon></button> 
                            }
                         </td>
                      </tr>
                   }
                </tbody>
             </table>
          </div>

          <!-- Footer Financials -->
          <div class="p-5 bg-slate-50 border-t border-slate-200 flex justify-end items-center gap-8 shrink-0">
             <div class="flex flex-col text-right">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Subtotal</span>
                <span class="text-sm font-semibold text-slate-700">{{ financialSummary().subTotal | number }}</span>
             </div>
             <div class="flex flex-col text-right">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Tax (0%)</span>
                <span class="text-sm font-semibold text-slate-700">{{ financialSummary().taxAmount | number }}</span>
             </div>
             <div class="flex flex-col text-right">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Discount</span>
                <div class="flex items-center justify-end gap-1">
                   <input type="number" [ngModel]="poDiscount()" (ngModelChange)="poDiscount.set($event)" class="w-20 text-right bg-transparent border-b border-slate-300 text-sm font-medium text-emerald-600 focus:border-emerald-500 outline-none" min="0">
                </div>
             </div>
             <div class="h-10 w-px bg-slate-200"></div>
             <div class="flex flex-col text-right">
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider">Grand Total</span>
                <span class="text-2xl font-bold text-slate-900 tracking-tight">{{ financialSummary().grandTotal | number }} <span class="text-sm font-medium text-slate-400">YER</span></span>
             </div>
             <button (click)="savePO()" [disabled]="poForm.invalid || poItems().length === 0" class="px-8 py-3 bg-teal-600 text-white rounded-xl font-bold shadow-lg shadow-teal-500/20 hover:bg-teal-700 transition-all flex items-center gap-2 ml-4 disabled:opacity-50 disabled:shadow-none disabled:bg-slate-400">
                <app-icon name="check" [size]="18"></app-icon> Confirm Order
             </button>
          </div>
       </div>
    </div>
  </div>
</ng-template>

<!-- Quick Product Modal Template -->
<ng-template #quickProductModal>
  <div class="absolute inset-0 z-[60] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm animate-fade-in p-4" (click)="closeQuickProductModal()">
     <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 border border-slate-100" (click)="$event.stopPropagation()">
        <h4 class="text-lg font-bold text-slate-800 mb-1">Add Product to Catalog</h4>
        <p class="text-xs text-slate-500 mb-4">Create a new item for <strong>{{ getBranchName(selectedBranchIdForPO()) }}</strong> to add to this PO.</p>
        <div class="space-y-3">
           <div><label class="block text-xs font-medium text-slate-500 mb-1">Product Name <span class="text-red-500">*</span></label><input type="text" [(ngModel)]="quickProduct.name" class="glass-input w-full px-3 py-2 rounded-lg text-sm border-slate-200 focus:border-teal-500 focus:ring-teal-500" placeholder="e.g. New Medicine 500mg"></div>
           <div class="grid grid-cols-2 gap-3">
              <div><label class="block text-xs font-medium text-slate-500 mb-1">SKU / Barcode</label><input type="text" [(ngModel)]="quickProduct.sku" class="glass-input w-full px-3 py-2 rounded-lg text-sm border-slate-200" placeholder="Auto-generated if empty"></div>
              <div><label class="block text-xs font-medium text-slate-500 mb-1">Category</label><select [(ngModel)]="quickProduct.category" class="glass-input w-full px-3 py-2 rounded-lg text-sm border-slate-200 bg-white"><option value="General">General</option><option value="Pharmaceuticals">Pharmaceuticals</option><option value="Equipment">Equipment</option></select></div>
           </div>
           <div><label class="block text-xs font-medium text-slate-500 mb-1">Cost Price <span class="text-red-500">*</span></label><div class="relative"><input type="number" [(ngModel)]="quickProduct.cost" min="0" class="glass-input w-full px-3 py-2 rounded-lg text-sm border-slate-200 font-bold text-slate-700" placeholder="0.00"><span class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-400">YER</span></div></div>
        </div>
        <div class="mt-6 flex justify-end gap-2">
           <button (click)="closeQuickProductModal()" class="px-4 py-2 text-xs font-medium text-slate-500 hover:text-slate-800 transition-colors">Cancel</button>
           <button (click)="saveQuickProduct()" [disabled]="!quickProduct.name || !quickProduct.cost" class="px-4 py-2 bg-teal-600 text-white rounded-lg text-xs font-bold hover:bg-teal-700 disabled:opacity-50 shadow-md shadow-teal-500/20 transition-all">Create & Select</button>
        </div>
     </div>
  </div>
</ng-template>

<!-- Supplier Modal Template -->
<ng-template #supplierModal>
  <div class="absolute inset-0 z-50 flex items-center justify-center bg-slate-900/20 backdrop-blur-sm animate-fade-in p-4" (click)="closeSupplierModal()">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl flex flex-col border border-slate-100" (click)="$event.stopPropagation()">
       <div class="p-6 border-b border-slate-100 bg-slate-50/50 rounded-t-2xl">
          <h3 class="text-xl font-medium text-slate-800">{{ editingId() ? 'Edit Supplier' : 'Add New Supplier' }}</h3>
       </div>
       <div class="p-6 overflow-y-auto max-h-[80vh]">
          <form [formGroup]="supplierForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
             <div class="md:col-span-2"><label class="block text-xs font-medium text-slate-700 mb-1">Name <span class="text-red-500">*</span></label><input type="text" formControlName="name" class="glass-input w-full px-3 py-2 rounded-lg text-sm"></div>
             <div><label class="block text-xs font-medium text-slate-700 mb-1">Code</label><input type="text" formControlName="code" class="glass-input w-full px-3 py-2 rounded-lg text-sm bg-slate-50" readonly></div>
             <div><label class="block text-xs font-medium text-slate-700 mb-1">Category</label><select formControlName="category" class="glass-input w-full px-3 py-2 rounded-lg text-sm bg-white"><option value="Pharmaceuticals">Pharmaceuticals</option><option value="Equipment">Equipment</option><option value="Services">Services</option></select></div>
             <div><label class="block text-xs font-medium text-slate-700 mb-1">Contact Person</label><input type="text" formControlName="contactPerson" class="glass-input w-full px-3 py-2 rounded-lg text-sm"></div>
             <div><label class="block text-xs font-medium text-slate-700 mb-1">Phone</label><input type="text" formControlName="phone" class="glass-input w-full px-3 py-2 rounded-lg text-sm"></div>
             <div class="md:col-span-2"><label class="block text-xs font-medium text-slate-700 mb-1">Address</label><input type="text" formControlName="address" class="glass-input w-full px-3 py-2 rounded-lg text-sm"></div>
          </form>
       </div>
       <div class="p-6 border-t border-slate-100 bg-slate-50 rounded-b-2xl flex justify-end gap-3">
          <button (click)="closeSupplierModal()" class="px-5 py-2 border border-slate-200 rounded-lg text-sm hover:bg-white">Cancel</button>
          <button (click)="saveSupplier()" [disabled]="supplierForm.invalid" class="px-5 py-2 bg-teal-500 text-white rounded-lg text-sm font-medium hover:bg-teal-600 disabled:opacity-50">Save Supplier</button>
       </div>
    </div>
  </div>
</ng-template>

<!-- Receive / Bill Modal Template with Attachment Upload -->
<ng-template #receiveModal>
  <div class="absolute inset-0 z-50 flex items-center justify-center bg-slate-900/30 backdrop-blur-sm animate-fade-in p-4" (click)="closeReceiveModal()">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col border border-slate-100" (click)="$event.stopPropagation()">
        <div class="p-6 border-b border-slate-100 bg-slate-50/50 rounded-t-2xl flex justify-between items-center">
           <div>
              @if (editingBillId()) {
                 <h3 class="text-xl font-medium text-slate-800">Bill Details & Payments</h3>
                 <p class="text-xs text-slate-500">Bill #{{ activeBill()?.billNumber }}</p>
              } @else if (activeReceivePOId) {
                 <h3 class="text-xl font-medium text-slate-800">Receive Order</h3>
                 <p class="text-xs text-slate-500">Processing PO: {{ activeReceivePOId }}</p>
              } @else {
                 <h3 class="text-xl font-medium text-slate-800">Register New Bill</h3>
                 <p class="text-xs text-slate-500">Manual entry</p>
              }
           </div>
           <button (click)="closeReceiveModal()" class="text-slate-400 hover:text-slate-600 p-2"><app-icon name="x" [size]="20"></app-icon></button>
        </div>
        
        <div class="p-6 overflow-y-auto">
           @if (!editingBillId()) {
              <!-- Bill Creation Form -->
              <form [formGroup]="receiveForm" class="space-y-4">
                 @if (!activeReceivePOId) {
                    <div>
                       <label class="block text-xs font-medium text-slate-700 mb-1">Linked Order</label>
                       <select (change)="onPoSelect($event)" class="glass-input w-full px-3 py-2 rounded-lg text-sm bg-white border-slate-200">
                          <option value="">-- Select Pending Order --</option>
                          @for (po of pendingPOs(); track po.id) {
                             <option [value]="po.id">{{ po.id }} - {{ getSupplierName(po.supplierId) }} ({{ po.grandTotal | number }})</option>
                          }
                       </select>
                    </div>
                 }
                 
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                       <label class="block text-xs font-medium text-slate-700 mb-1">Bill Number <span class="text-red-500">*</span></label>
                       <input type="text" formControlName="billNumber" class="glass-input w-full px-3 py-2 rounded-lg text-sm bg-white">
                    </div>
                    <div>
                       <label class="block text-xs font-medium text-slate-700 mb-1">Bill Date <span class="text-red-500">*</span></label>
                       <input type="date" formControlName="billDate" class="glass-input w-full px-3 py-2 rounded-lg text-sm bg-white">
                    </div>
                    <div>
                       <label class="block text-xs font-medium text-slate-700 mb-1">Received Date</label>
                       <input type="date" formControlName="receivedDate" class="glass-input w-full px-3 py-2 rounded-lg text-sm bg-white">
                    </div>
                    <div>
                       <label class="block text-xs font-medium text-slate-700 mb-1">Due Date</label>
                       <input type="date" formControlName="dueDate" class="glass-input w-full px-3 py-2 rounded-lg text-sm bg-white">
                    </div>
                 </div>

                 <!-- Invoice/Bill File Upload -->
                 <div class="border-2 border-dashed border-slate-200 rounded-xl p-4 flex flex-col items-center justify-center text-center hover:bg-slate-50 transition-colors relative cursor-pointer group">
                    <input type="file" (change)="handleBillUpload($event)" accept=".pdf,.png,.jpg,.jpeg" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                    @if (billUploadedName()) {
                       <div class="flex items-center gap-3">
                          <div class="p-2 bg-teal-50 rounded-lg text-teal-600">
                             <app-icon name="file-text" [size]="24"></app-icon>
                          </div>
                          <div class="text-left">
                             <p class="text-sm font-medium text-slate-700">{{ billUploadedName() }}</p>
                             <p class="text-xs text-slate-500">Click to replace</p>
                          </div>
                          <button type="button" (click)="billUploadedName.set(''); billTempUrl.set(null); $event.stopPropagation()" class="p-1 text-slate-400 hover:text-red-500 ml-2">
                             <app-icon name="x" [size]="16"></app-icon>
                          </button>
                       </div>
                    } @else {
                       <app-icon name="upload-cloud" [size]="32" class="text-slate-400 mb-2 group-hover:text-teal-500 transition-colors"></app-icon>
                       <p class="text-sm text-slate-600 font-medium">Upload Invoice Copy</p>
                       <p class="text-xs text-slate-400 mt-1">PDF, PNG, or JPEG (Max 10MB)</p>
                    }
                 </div>
              </form>
           } @else {
              <!-- Payment Mode (Bill Details & Payments) -->
              <div class="space-y-6">
                 <!-- Balance Overview -->
                 <div class="grid grid-cols-3 gap-4">
                    <div class="p-3 bg-slate-50 rounded-lg border border-slate-100 text-center">
                       <div class="text-[10px] uppercase text-slate-400 font-bold">Total</div>
                       <div class="text-lg font-bold text-slate-800">{{ activeBill()?.totalAmount | number }}</div>
                    </div>
                    <div class="p-3 bg-emerald-50 rounded-lg border border-emerald-100 text-center">
                       <div class="text-[10px] uppercase text-emerald-600 font-bold">Paid</div>
                       <div class="text-lg font-bold text-emerald-700">{{ activeBill()?.paidAmount | number }}</div>
                    </div>
                    <div class="p-3 bg-red-50 rounded-lg border border-red-100 text-center">
                       <div class="text-[10px] uppercase text-red-600 font-bold">Balance</div>
                       <div class="text-lg font-bold text-red-700">{{ remainingBalance() | number }}</div>
                    </div>
                 </div>

                 <!-- View Original Invoice Button -->
                 @if (activeBill()?.attachmentUrl) {
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-200">
                       <div class="flex items-center gap-3">
                          <div class="p-2 bg-white rounded-lg border border-slate-200 text-slate-500">
                             <app-icon name="file-text" [size]="20"></app-icon>
                          </div>
                          <div>
                             <p class="text-sm font-medium text-slate-700">{{ activeBill()?.attachmentName || 'Invoice Document' }}</p>
                             <p class="text-xs text-slate-500">Supplier Invoice</p>
                          </div>
                       </div>
                       <button (click)="viewOriginalBill()" class="px-3 py-1.5 bg-white border border-slate-200 rounded-lg text-xs font-medium text-slate-600 hover:bg-slate-50 flex items-center gap-1.5 transition-colors">
                          <app-icon name="eye" [size]="14"></app-icon> View
                       </button>
                    </div>
                 }

                 <!-- Add Payment Form -->
                 @if (remainingBalance() > 0) {
                    <form [formGroup]="paymentForm" class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                       <h4 class="text-xs font-bold text-slate-500 uppercase mb-3">Record Payment</h4>
                       <div class="grid grid-cols-2 gap-3 mb-3">
                          <div>
                             <label class="block text-[10px] font-bold text-slate-400 mb-1">Date</label>
                             <input type="date" formControlName="date" class="glass-input w-full px-3 py-1.5 rounded-lg text-sm bg-white">
                          </div>
                          <div>
                             <label class="block text-[10px] font-bold text-slate-400 mb-1">Method</label>
                             <select formControlName="method" class="glass-input w-full px-3 py-1.5 rounded-lg text-sm bg-white">
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Check">Check</option>
                             </select>
                          </div>
                       </div>
                       <div class="mb-3">
                          <label class="block text-[10px] font-bold text-slate-400 mb-1">Amount (YER)</label>
                          <div class="flex gap-2">
                             <input type="number" formControlName="amount" class="glass-input flex-1 px-3 py-1.5 rounded-lg text-sm bg-white font-bold">
                             <button type="button" (click)="setFullBalance()" class="text-xs text-teal-600 hover:underline px-2">Full</button>
                          </div>
                       </div>
                       <div class="mb-3">
                          <label class="block text-[10px] font-bold text-slate-400 mb-1">Reference</label>
                          <input type="text" formControlName="reference" placeholder="Check #, Transaction ID..." class="glass-input w-full px-3 py-1.5 rounded-lg text-sm bg-white">
                       </div>
                       
                       <!-- Payment Receipt Upload -->
                       <div class="mb-4">
                          <label class="block text-[10px] font-bold text-slate-400 mb-1">Receipt Attachment</label>
                          <div class="border border-dashed border-slate-300 rounded-lg p-3 flex items-center justify-center text-center hover:bg-white transition-colors relative cursor-pointer">
                             <input type="file" (change)="handleReceiptUpload($event)" accept=".pdf,.png,.jpg,.jpeg" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                             @if (uploadedFileName()) {
                                <div class="flex items-center gap-2">
                                   <app-icon name="paperclip" [size]="14" class="text-teal-600"></app-icon>
                                   <span class="text-xs font-medium text-slate-700">{{ uploadedFileName() }}</span>
                                   <button type="button" (click)="uploadedFileName.set(''); tempFileUrl.set(null); $event.stopPropagation()" class="p-0.5 text-slate-400 hover:text-red-500">
                                      <app-icon name="x" [size]="12"></app-icon>
                                   </button>
                                </div>
                             } @else {
                                <div class="flex items-center gap-2 text-slate-400">
                                   <app-icon name="paperclip" [size]="14"></app-icon>
                                   <span class="text-xs">Attach receipt (optional)</span>
                                </div>
                             }
                          </div>
                       </div>
                       
                       <div class="flex justify-end">
                          <button (click)="submitPayment()" [disabled]="paymentForm.invalid || isAmountInvalid()" class="px-4 py-2 bg-slate-800 text-white rounded-lg text-xs font-bold hover:bg-slate-700 disabled:opacity-50 flex items-center gap-2">
                             <app-icon name="check" [size]="14"></app-icon> Add Payment
                          </button>
                       </div>
                    </form>
                 }

                 <!-- Payment History -->
                 <div>
                    <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Payment History</h4>
                    @if (activeBill()?.payments && activeBill()!.payments.length > 0) {
                       <table class="w-full text-left text-xs">
                          <thead class="bg-slate-50 text-slate-400">
                             <tr>
                                <th class="p-2">Date</th>
                                <th class="p-2">Reference</th>
                                <th class="p-2 text-center">Receipt</th>
                                <th class="p-2 text-right">Amount</th>
                             </tr>
                          </thead>
                          <tbody class="divide-y divide-slate-100">
                             @for (pay of activeBill()?.payments; track pay.id) {
                                <tr class="hover:bg-slate-50">
                                   <td class="p-2">{{ pay.date }}</td>
                                   <td class="p-2 text-slate-500">{{ pay.method }} {{ pay.reference ? '- ' + pay.reference : '' }}</td>
                                   <td class="p-2 text-center">
                                      @if (pay.fileUrl) {
                                         <button (click)="viewReceipt(pay)" class="p-1 hover:bg-slate-100 rounded text-teal-600" title="View Receipt">
                                            <app-icon name="eye" [size]="14"></app-icon>
                                         </button>
                                      } @else {
                                         <span class="text-slate-300">-</span>
                                      }
                                   </td>
                                   <td class="p-2 text-right font-medium text-emerald-600">{{ pay.amount | number }}</td>
                                </tr>
                             }
                          </tbody>
                       </table>
                    } @else {
                       <div class="text-center py-6 text-slate-400 text-xs">No payments recorded yet</div>
                    }
                 </div>
              </div>
           }
        </div>

        @if (!editingBillId()) {
           <div class="p-6 border-t border-slate-100 bg-slate-50 rounded-b-2xl flex justify-end gap-3">
              <button (click)="closeReceiveModal()" class="px-5 py-2 border border-slate-200 rounded-lg text-sm hover:bg-white">Cancel</button>
              <button (click)="saveBill()" [disabled]="receiveForm.invalid || !activeReceivePOId" class="px-5 py-2 bg-teal-600 text-white rounded-lg text-sm font-medium hover:bg-teal-700 disabled:opacity-50 flex items-center gap-2">
                 <app-icon name="check" [size]="16"></app-icon> Confirm Bill
              </button>
           </div>
        }
     </div>
  </div>
</ng-template>

<!-- Deactivate Modal Template -->
<ng-template #deactivateModal>
  <div class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/20 backdrop-blur-sm animate-fade-in p-4">
     <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full border border-slate-100">
        <div class="flex flex-col items-center text-center gap-4">
           <div class="w-12 h-12 rounded-full bg-amber-100 text-amber-500 flex items-center justify-center">
              <app-icon name="alert-circle" [size]="24"></app-icon>
           </div>
           <div>
              <h3 class="text-lg font-semibold text-slate-800">Deactivate Supplier?</h3>
              <p class="text-sm text-slate-500 mt-2">This will prevent new POs from being created for this supplier. Existing records remain.</p>
           </div>
           <div class="flex gap-3 w-full mt-2">
              <button (click)="closeDeactivateModal()" class="flex-1 px-4 py-2 border border-slate-200 text-slate-600 rounded-lg hover:bg-slate-50 font-medium text-sm">Cancel</button>
              <button (click)="confirmDeactivation()" class="flex-1 px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 shadow-lg shadow-amber-500/30 font-medium text-sm">Deactivate</button>
           </div>
        </div>
     </div>
  </div>
</ng-template>

<!-- Receipt/Document Viewer Modal Template -->
<ng-template #receiptViewer>
  <div class="fixed inset-0 z-[70] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm animate-fade-in p-4" (click)="closeReceiptModal()">
     <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[85vh] flex flex-col border border-slate-100 overflow-hidden" (click)="$event.stopPropagation()">
        <!-- Viewer Header -->
        <div class="px-6 py-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center shrink-0">
           <div class="flex items-center gap-3">
              <div class="p-2 bg-white rounded-lg border border-slate-200 text-slate-500">
                 <app-icon name="file-text" [size]="20"></app-icon>
              </div>
              <div>
                 <h3 class="text-lg font-bold text-slate-800">{{ viewerTitle() }}</h3>
                 <p class="text-xs text-slate-500">{{ selectedReceiptName() }}</p>
              </div>
           </div>
           <div class="flex items-center gap-2">
              @if (selectedReceiptUrl()) {
                 <a [href]="selectedReceiptUrl()" download [attr.download]="selectedReceiptName()" class="px-3 py-1.5 bg-slate-100 hover:bg-slate-200 rounded-lg text-xs font-medium text-slate-600 flex items-center gap-1.5 transition-colors">
                    <app-icon name="download" [size]="14"></app-icon> Download
                 </a>
              }
              <button (click)="closeReceiptModal()" class="text-slate-400 hover:text-slate-600 p-2 hover:bg-slate-100 rounded-full transition-colors">
                 <app-icon name="x" [size]="20"></app-icon>
              </button>
           </div>
        </div>
        
        <!-- Viewer Content -->
        <div class="flex-1 bg-slate-100 flex items-center justify-center overflow-auto p-4">
           @if (selectedReceiptUrl()) {
              @if (isPdf(selectedReceiptName())) {
                 <iframe [src]="getSafeUrl(selectedReceiptUrl()!)" class="w-full h-full rounded-lg border border-slate-200 bg-white"></iframe>
              } @else {
                 <img [src]="selectedReceiptUrl()" [alt]="selectedReceiptName()" class="max-w-full max-h-full object-contain rounded-lg shadow-lg">
              }
           } @else {
              <div class="text-center text-slate-400">
                 <app-icon name="file-x" [size]="48" class="mb-3 opacity-50"></app-icon>
                 <p class="text-sm">No document available</p>
              </div>
           }
        </div>
     </div>
  </div>
</ng-template>

<!-- Action Menu Template -->
<ng-template #actionMenu>
  <div 
    class="fixed z-50 bg-white rounded-lg shadow-xl border border-slate-100 py-1 w-56 text-left animate-fade-in"
    [style.top.px]="actionMenuPosition().y"
    [style.left.px]="actionMenuPosition().x"
    (click)="$event.stopPropagation()"
  >
    @if (currentView() === 'procurement-orders') {
       <button (click)="editPOFromMenu()" class="w-full text-left px-4 py-2 text-xs text-slate-600 hover:bg-slate-50 hover:text-teal-600 flex items-center gap-2"><app-icon name="edit-3" [size]="14"></app-icon> Edit Details</button>
       <div class="h-px bg-slate-100 my-1"></div>
       <button (click)="updatePOStatusFromMenu('Sent')" class="w-full text-left px-4 py-2 text-xs text-slate-600 hover:bg-slate-50 flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-blue-500"></div> Mark as Sent</button>
       <button (click)="openReceiveModalFromMenu()" class="w-full text-left px-4 py-2 text-xs font-bold text-slate-700 bg-slate-50 hover:bg-slate-100 flex items-center gap-2 border-t border-b border-slate-100 my-1"><app-icon name="file-text" [size]="14"></app-icon> Convert to Bill</button>
       <button (click)="deletePOFromMenu()" class="w-full text-left px-4 py-2 text-xs text-red-500 hover:bg-red-50 flex items-center gap-2"><app-icon name="trash-2" [size]="14"></app-icon> Delete Order</button>
    }
    @if (currentView() === 'procurement-suppliers') {
       <button (click)="editSupplierFromMenu()" class="w-full text-left px-4 py-2 text-xs text-slate-600 hover:bg-slate-50 flex items-center gap-2"><app-icon name="edit-3" [size]="14"></app-icon> Edit Details</button>
       <button (click)="deleteSupplierFromMenu()" class="w-full text-left px-4 py-2 text-xs text-amber-600 hover:bg-amber-50 flex items-center gap-2 font-medium"><app-icon name="trash-2" [size]="14"></app-icon> Deactivate</button>
    }
  </div>
</ng-template>

